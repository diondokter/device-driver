<!DOCTYPE HTML>
<html lang="en" class="light sidebar-visible" dir="ltr">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>device-driver-book</title>
        <meta name="robots" content="noindex">


        <!-- Custom HTML head -->

        <meta name="description" content="">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff">

        <link rel="icon" href="favicon-de23e50b.svg">
        <link rel="shortcut icon" href="favicon-8114d1fc.png">
        <link rel="stylesheet" href="css/variables-8adf115d.css">
        <link rel="stylesheet" href="css/general-2459343d.css">
        <link rel="stylesheet" href="css/chrome-ae938929.css">
        <link rel="stylesheet" href="css/print-9e4910d8.css" media="print">

        <!-- Fonts -->
        <link rel="stylesheet" href="fonts/fonts-9644e21d.css">

        <!-- Highlight.js Stylesheets -->
        <link rel="stylesheet" id="mdbook-highlight-css" href="highlight-493f70e1.css">
        <link rel="stylesheet" id="mdbook-tomorrow-night-css" href="tomorrow-night-4c0ae647.css">
        <link rel="stylesheet" id="mdbook-ayu-highlight-css" href="ayu-highlight-3fdfc3ac.css">

        <!-- Custom theme stylesheets -->


        <!-- Provide site root and default themes to javascript -->
        <script>
            const path_to_root = "";
            const default_light_theme = "light";
            const default_dark_theme = "navy";
            window.path_to_searchindex_js = "searchindex-8bdbbae6.js";
        </script>
        <!-- Start loading toc.js asap -->
        <script src="toc-e9341926.js"></script>
    </head>
    <body>
    <div id="mdbook-help-container">
        <div id="mdbook-help-popup">
            <h2 class="mdbook-help-title">Keyboard shortcuts</h2>
            <div>
                <p>Press <kbd>←</kbd> or <kbd>→</kbd> to navigate between chapters</p>
                <p>Press <kbd>S</kbd> or <kbd>/</kbd> to search in the book</p>
                <p>Press <kbd>?</kbd> to show this help</p>
                <p>Press <kbd>Esc</kbd> to hide this help</p>
            </div>
        </div>
    </div>
    <div id="mdbook-body-container">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script>
            try {
                let theme = localStorage.getItem('mdbook-theme');
                let sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script>
            const default_theme = window.matchMedia("(prefers-color-scheme: dark)").matches ? default_dark_theme : default_light_theme;
            let theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { }
            if (theme === null || theme === undefined) { theme = default_theme; }
            const html = document.documentElement;
            html.classList.remove('light')
            html.classList.add(theme);
            html.classList.add("js");
        </script>

        <input type="checkbox" id="mdbook-sidebar-toggle-anchor" class="hidden">

        <!-- Hide / unhide sidebar before it is displayed -->
        <script>
            let sidebar = null;
            const sidebar_toggle = document.getElementById("mdbook-sidebar-toggle-anchor");
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            } else {
                sidebar = 'hidden';
                sidebar_toggle.checked = false;
            }
            if (sidebar === 'visible') {
                sidebar_toggle.checked = true;
            } else {
                html.classList.remove('sidebar-visible');
            }
        </script>

        <nav id="mdbook-sidebar" class="sidebar" aria-label="Table of contents">
            <!-- populated by js -->
            <mdbook-sidebar-scrollbox class="sidebar-scrollbox"></mdbook-sidebar-scrollbox>
            <noscript>
                <iframe class="sidebar-iframe-outer" src="toc.html"></iframe>
            </noscript>
            <div id="mdbook-sidebar-resize-handle" class="sidebar-resize-handle">
                <div class="sidebar-resize-indicator"></div>
            </div>
        </nav>

        <div id="mdbook-page-wrapper" class="page-wrapper">

            <div class="page">
                <div id="mdbook-menu-bar-hover-placeholder"></div>
                <div id="mdbook-menu-bar" class="menu-bar sticky">
                    <div class="left-buttons">
                        <label id="mdbook-sidebar-toggle" class="icon-button" for="mdbook-sidebar-toggle-anchor" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="mdbook-sidebar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M0 96C0 78.3 14.3 64 32 64H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32C14.3 128 0 113.7 0 96zM0 256c0-17.7 14.3-32 32-32H416c17.7 0 32 14.3 32 32s-14.3 32-32 32H32c-17.7 0-32-14.3-32-32zM448 416c0 17.7-14.3 32-32 32H32c-17.7 0-32-14.3-32-32s14.3-32 32-32H416c17.7 0 32 14.3 32 32z"/></svg></span>
                        </label>
                        <button id="mdbook-theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="mdbook-theme-list">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M371.3 367.1c27.3-3.9 51.9-19.4 67.2-42.9L600.2 74.1c12.6-19.5 9.4-45.3-7.6-61.2S549.7-4.4 531.1 9.6L294.4 187.2c-24 18-38.2 46.1-38.4 76.1L371.3 367.1zm-19.6 25.4l-116-104.4C175.9 290.3 128 339.6 128 400c0 3.9 .2 7.8 .6 11.6c1.8 17.5-10.2 36.4-27.8 36.4H96c-17.7 0-32 14.3-32 32s14.3 32 32 32H240c61.9 0 112-50.1 112-112c0-2.5-.1-5-.2-7.5z"/></svg></span>
                        </button>
                        <ul id="mdbook-theme-list" class="theme-popup" aria-label="Themes" role="menu">
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-default_theme">Auto</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-light">Light</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-rust">Rust</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-coal">Coal</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-navy">Navy</button></li>
                            <li role="none"><button role="menuitem" class="theme" id="mdbook-theme-ayu">Ayu</button></li>
                        </ul>
                        <button id="mdbook-search-toggle" class="icon-button" type="button" title="Search (`/`)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="/ s" aria-controls="mdbook-searchbar">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M416 208c0 45.9-14.9 88.3-40 122.7L502.6 457.4c12.5 12.5 12.5 32.8 0 45.3s-32.8 12.5-45.3 0L330.7 376c-34.4 25.2-76.8 40-122.7 40C93.1 416 0 322.9 0 208S93.1 0 208 0S416 93.1 416 208zM208 352c79.5 0 144-64.5 144-144s-64.5-144-144-144S64 128.5 64 208s64.5 144 144 144z"/></svg></span>
                        </button>
                    </div>

                    <h1 class="menu-title">device-driver-book</h1>

                    <div class="right-buttons">
                        <a href="print.html" title="Print this book" aria-label="Print this book">
                            <span class=fa-svg id="print-button"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M128 0C92.7 0 64 28.7 64 64v96h64V64H354.7L384 93.3V160h64V93.3c0-17-6.7-33.3-18.7-45.3L400 18.7C388 6.7 371.7 0 354.7 0H128zM384 352v32 64H128V384 368 352H384zm64 32h32c17.7 0 32-14.3 32-32V256c0-35.3-28.7-64-64-64H64c-35.3 0-64 28.7-64 64v96c0 17.7 14.3 32 32 32H64v64c0 35.3 28.7 64 64 64H384c35.3 0 64-28.7 64-64V384zm-16-88c-13.3 0-24-10.7-24-24s10.7-24 24-24s24 10.7 24 24s-10.7 24-24 24z"/></svg></span>
                        </a>
                        <a href="https://github.com/diondokter/device-driver" title="Git repository" aria-label="Git repository">
                            <span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M392.8 1.2c-17-4.9-34.7 5-39.6 22l-128 448c-4.9 17 5 34.7 22 39.6s34.7-5 39.6-22l128-448c4.9-17-5-34.7-22-39.6zm80.6 120.1c-12.5 12.5-12.5 32.8 0 45.3L562.7 256l-89.4 89.4c-12.5 12.5-12.5 32.8 0 45.3s32.8 12.5 45.3 0l112-112c12.5-12.5 12.5-32.8 0-45.3l-112-112c-12.5-12.5-32.8-12.5-45.3 0zm-306.7 0c-12.5-12.5-32.8-12.5-45.3 0l-112 112c-12.5 12.5-12.5 32.8 0 45.3l112 112c12.5 12.5 32.8 12.5 45.3 0s12.5-32.8 0-45.3L77.3 256l89.4-89.4c12.5-12.5 12.5-32.8 0-45.3z"/></svg></span>
                        </a>

                    </div>
                </div>

                <div id="mdbook-search-wrapper" class="hidden">
                    <form id="mdbook-searchbar-outer" class="searchbar-outer">
                        <div class="search-wrapper">
                            <input type="search" id="mdbook-searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="mdbook-searchresults-outer" aria-describedby="searchresults-header">
                            <div class="spinner-wrapper">
                                <span class=fa-svg id="fa-spin"><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M304 48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zm0 416c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM48 304c26.5 0 48-21.5 48-48s-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48zm464-48c0-26.5-21.5-48-48-48s-48 21.5-48 48s21.5 48 48 48s48-21.5 48-48zM142.9 437c18.7-18.7 18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zm0-294.2c18.7-18.7 18.7-49.1 0-67.9S93.7 56.2 75 75s-18.7 49.1 0 67.9s49.1 18.7 67.9 0zM369.1 437c18.7 18.7 49.1 18.7 67.9 0s18.7-49.1 0-67.9s-49.1-18.7-67.9 0s-18.7 49.1 0 67.9z"/></svg></span>
                            </div>
                        </div>
                    </form>
                    <div id="mdbook-searchresults-outer" class="searchresults-outer hidden">
                        <div id="mdbook-searchresults-header" class="searchresults-header"></div>
                        <ul id="mdbook-searchresults">
                        </ul>
                    </div>
                </div>

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script>
                    document.getElementById('mdbook-sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('mdbook-sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#mdbook-sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="mdbook-content" class="content">
                    <main>
                        <h1 id="device-driver-toolkit"><a class="header" href="#device-driver-toolkit">Device-driver toolkit</a></h1>
<p><a href="https://crates.io/crates/device-driver"><img src="https://img.shields.io/crates/v/device-driver.svg" alt="crates.io"></a> <a href="https://docs.rs/device-driver"><img src="https://docs.rs/device-driver/badge.svg" alt="Documentation"></a></p>
<blockquote>
<p>A toolkit to write better device drivers, faster.</p>
</blockquote>
<p>This book aims to guide you to write your own device drivers using the device-driver toolkit.
It is not a replacement of the <a href="https://docs.rs/device-driver">docs</a> though. The documentation describes all the small details while this book is concerned with more big-picture concepts and the description of the DSL and manifest (JSON, YAML and TOML) inputs.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Definitions are important!<br>The name <code>device-driver</code> consists of two parts:</p>
<ul>
<li><code>driver</code>: Code to enable the use of hardware.</li>
<li><code>device</code>: A chip or peripheral you can talk to over a bus.</li>
</ul>
<p>Examples of good targets for using this toolkit:</p>
<ul>
<li>An I2C accelerometer</li>
<li>A SPI radio transceiver</li>
<li>A screen/display with parallel bus</li>
</ul>
<p>The driver is usable in any no-std context and can be made to work with the <code>embedded-hal</code> crate or any custom interfaces.</p>
</blockquote>
<p>(In theory this toolkit can be used for memory-mapped peripherals too, but there are likely better crates to use for that like <code>svd2rust</code> and <code>chiptool</code>. The major difference is that this toolkit assumes device interfaces to be fallible.)</p>
<details>
  <summary>Sneak peak of yaml register definition</summary>
<pre><code class="language-yaml">SYNT:
  type: register
  address: 0x05
  size_bits: 32
  reset_value: 0x42162762
  fields:
    PLL_CP_ISEL:
      base: uint
      start: 29
      end: 32
      description: Set the charge pump current according to the XTAL frequency (see Table 37. Table 34).
    BS:
      base: bool
      start: 28
      description: |
        Synthesizer band select. This parameter selects the out-of loop
        divide factor of the synthesizer:
        - false: 4, band select factor for high band
        - true: 8, band select factor for middle band
        (see Section 5.3.1 RF channel frequency settings).
    SYNT:
      base: uint
      start: 0
      end: 28
      description: The PLL programmable divider (see Section 5.3.1 RF channel frequency settings).
</code></pre>
</details>
<h2 id="book-overview"><a class="header" href="#book-overview">Book overview:</a></h2>
<ul>
<li>The intro chapter describes the goal of the toolkit, what it does for you and why you may want to use it instead of writing the driver manually.</li>
<li>After the intro are chapters about how to generate and then import the driver code into your project. This can be done during compilation through a proc-macro or ahead of time with the CLI and <code>include!</code>.</li>
<li>Next is a chapter about creating a driver interface where you’ll see how to implement the right traits so the generated driver can talk with your device.</li>
<li>Then the actual definition of the driver is covered. These chapters teach what options there are for defining registers, commands, buffers and more using either the DSL or a manifest language like YAML.</li>
</ul>
<p>The addendum contains more things that mostly provide useful background information.</p>
<blockquote class="blockquote-tag blockquote-tag-caution">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p>
<p>It’s hard to keep book like this up-to-date with reality. Small errors might creep in despite my best effort.<br>If you do find something out of place, missing or simply wrong, please open an issue, even if it’s just for a typo! I’d really appreciate it and helps out everyone.</p>
</blockquote>
<h2 id="known-drivers-using-the-toolkit"><a class="header" href="#known-drivers-using-the-toolkit">Known drivers using the toolkit:</a></h2>
<p>It’s nice to have examples:</p>
<ul>
<li><a href="https://github.com/diondokter/s2lp">S2-LP radio</a></li>
<li><a href="https://github.com/thermigo/npm1300-rs">Nordic nPM1300 Power Management IC</a></li>
<li><a href="https://github.com/tactile-eng/iqs323-driver">iqs323 inductive/capacitive sensing controller</a></li>
<li><a href="https://github.com/LeFrenchPOC/vcnl36825t-rs">VCNL36825T proximity sensor</a></li>
<li><a href="https://github.com/okhsunrog/axp192-dd">AXP192 Power Management IC</a></li>
<li><a href="https://github.com/okhsunrog/fusb302b">ONSEMI FUSB302B USB-PD PHY</a></li>
<li><a href="https://github.com/trappitsch/ic-md">iC-Haus iC-MD 48bit quadrature counter</a></li>
</ul>
<p>Feel free to add to this list!</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="intro"><a class="header" href="#intro">Intro</a></h1>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>We deserve better drivers. Rust has shown that we don’t need to stick to old principles and that we as an industry can do better.</p>
</blockquote>
<p>Device-driver is a Rust toolkit that generates safe, documented interfaces for hardware devices, handling bit-packed registers and device commands through an expressive macro DSL or config file.</p>
<p>While the Rust language provides many opportunities to improve the way we write drivers, it doesn’t mean those are easy to use. There are two issues:</p>
<ol>
<li>Creating good datastructures to represent the driver is hard</li>
<li>Writing the definitions by hand takes a lot of thankless work</li>
</ol>
<p>By using this toolkit, you get both 1 and 2 solved.</p>
<p>Number one is solved by getting the datastructures as part of this toolkit which has seen over 5 years of iteration and improvements. The second issue is solved by using code generation so you only need to manually take care of the things that make your driver unique.</p>
<p>Together, this delivers a really tight and precise way of authoring your device driver:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>device_driver::create_device!(
    device_name: MyDevice,
    dsl: {
        config {
            type RegisterAddressType = u8;
        }
        /// This is the Foo register
        register Foo {
            const ADDRESS = 0;
            const SIZE_BITS = 8;

            /// This is a bool at bit 0!
            value0: bool = 0,
            /// Integrated enum generation
            value1: int as enum GeneratedEnum {
              A,
              /// Variant B
              B,
              C = default,
            } = 1..4,
            /// This is a 4-bit integer
            value2: uint = 4..8,
        },
    }
);

let mut device = MyDevice::new(device_interface);
device.foo().write(|reg| reg.set_value_1(GeneratedEnum::B)).unwrap();
<span class="boring">}</span></code></pre>
<p>Instantly we get a nice and familiar API that is well documented. There’s a bunch more features to discover like using YAML as the input and a bunch of analysis steps, so read on!</p>
<h2 id="the-goal"><a class="header" href="#the-goal">The goal</a></h2>
<p>When you’re writing a driver, you just want to implement it and be done with it. Most of the time developing a driver is boring and repetitive.</p>
<p>To help you do less of the boring work and to create a higher quality driver at the same time, the goals are:</p>
<ol>
<li>Get a great driver for minimal effort</li>
<li>Get a driver that is correct and hard to misuse
<ul>
<li>(assuming the input spec is correct)</li>
</ul>
</li>
<li>Get a driver that is well documented
<ul>
<li>(assuming the input spec gives docs)</li>
</ul>
</li>
</ol>
<p>These goals are met by:</p>
<ul>
<li>Using a dense and precise input language</li>
<li>Having many options do deal with byte and bit ordering</li>
<li>Having analysis steps to decrease the chance of common mistakes</li>
<li>Separating the interface to the device from the definitions</li>
<li>Allowing you to put docs on pretty much anything</li>
</ul>
<h2 id="how-to-continue"><a class="header" href="#how-to-continue">How to continue</a></h2>
<p>Simply read the rest of the book!</p>
<p>Looking at existing drivers and examples can also be very helpful.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="using-the-macro"><a class="header" href="#using-the-macro">Using the macro</a></h1>
<p>The macro is the main way of generating a driver. It is defined in the <code>device-driver-macros</code> crate which is re-exported in the <code>device-driver</code> crate by default. You don’t have import the macros crate yourself.</p>
<p>The macro can be used in two forms.</p>
<h2 id="inline-dsl"><a class="header" href="#inline-dsl">Inline DSL</a></h2>
<p>The first form is for writing the register definitions using the DSL right in the source of your project.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>device_driver::create_device!(
    device_name: MyTestDevice,
    dsl: {
        // DSL code goes here
    }
)
<span class="boring">}</span></code></pre>
<p>It consists of two parts:</p>
<ul>
<li><code>device_name</code>: This will be the name of the root block that will take ownership of the device interface.
<ul>
<li>The name must be provided in PascalCase</li>
<li>If you’re going to distribute this as the main part of your driver, then it’s recommended to use the name
of the chip this driver is for. For example: ‘Lis3dh’</li>
<li>If you’re going to write a higher level wrapper around it, then it’s recommended to name it something
appropriate for a low level layer. For example: ‘Registers’ or ‘LowLevel’</li>
</ul>
</li>
<li><code>dsl</code>: This selects the option to write DSL code in the macro</li>
</ul>
<p>Using the DSL in this way allows for nice error messages and keeps the definitions close to your code.</p>
<h2 id="manifest-file"><a class="header" href="#manifest-file">Manifest file</a></h2>
<p>The second form uses an external manifest file.</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>device_driver::create_device!(
    device_name: MyTestDevice,
    manifest: "driver-manifest.yaml"
)
<span class="boring">}</span></code></pre>
<p>You can provide an absolute path or a relative path to the file. If it’s relative, then the base path is the value of the <a href="https://doc.rust-lang.org/cargo/reference/environment-variables.html"><code>CARGO_MANIFEST_DIR</code> environment variable</a>. This is the same directory as your <code>Cargo.toml</code> is in.</p>
<p>The extension of the file determines which parser is used.</p>
<p>The options are:</p>
<ul>
<li>yaml</li>
<li>json</li>
<li>toml</li>
<li>dsl</li>
</ul>
<h2 id="output"><a class="header" href="#output">Output</a></h2>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>The generated code is placed exactly where the macro is invoked. This means you can decide to contain everything in its own module. This is recommended to do, but not required.</p>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-caution">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p>
<p>Code in the same module as the generated code is able to access the private API of the generated code. It is discouraged to make use of the private API since it’s not considered as part of the SemVer guarantees and it’s designed in a way where you shouldn’t need to.</p>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>If you feel part of the private API should be stabilized, then please open an issue to discuss it. If you really need to access the private API, consider pinning the exact device-driver versions and make sure to pin the sub crates too, including the generation and the macros crate.</p>
</blockquote>
<h2 id="optimizing-compile-times"><a class="header" href="#optimizing-compile-times">Optimizing compile times</a></h2>
<p>The device-driver crate has features for turning on the json, yaml and toml parsers. These are enabled by default for your convenience.</p>
<p>Once you’ve settled on a format, you can optimize the compile times for you and your dependents by disabling the default features and adding back the features you need.</p>
<p>Suggestions:</p>
<ul>
<li>When using the DSL (inline or as manifest)
<ul>
<li><code>default-features = false</code></li>
<li><code>features = ["dsl"]</code></li>
</ul>
</li>
<li>When using yaml
<ul>
<li><code>default-features = false</code></li>
<li><code>features = ["yaml"]</code></li>
</ul>
</li>
<li>When using json
<ul>
<li><code>default-features = false</code></li>
<li><code>features = ["json"]</code></li>
</ul>
</li>
<li>When using toml
<ul>
<li><code>default-features = false</code></li>
<li><code>features = ["toml"]</code></li>
</ul>
</li>
</ul>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>With these steps the compile times should be acceptable. However, they can be further optimized by getting rid of the macro altogether. This is explained in the cli chapter.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="using-the-cli"><a class="header" href="#using-the-cli">Using the cli</a></h1>
<p>The cli is there to optimize compile times for your driver users. Instead of having to compile the device-driver macros and run them, you can generate the code ahead of time and then <code>include!</code> or make a module out of it.</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>During development using the proc macro will be lots easier since the code generation won’t go out of sync with the driver definitions. Then once the development is done, you may want to use the CLI as an optimization.</p>
</blockquote>
<h2 id="installation"><a class="header" href="#installation">Installation</a></h2>
<p>The cli can be installed using cargo:</p>
<pre><code class="language-bash">cargo install device-driver-cli
</code></pre>
<p>This always supports all input formats.</p>
<h2 id="usage"><a class="header" href="#usage">Usage</a></h2>
<p>The CLI is written with clap and has a minimal and simple interface.</p>
<p>To see all options, use:</p>
<pre><code class="language-bash">device-driver-cli --help
</code></pre>
<p>To do the code generation three things are required:</p>
<ul>
<li><code>-m</code> or <code>--manifest</code>: The path to the manifest file</li>
<li><code>-o</code> or <code>--output</code>: The path to the to be generated rust file</li>
<li><code>-d</code> or <code>--device-name</code>: The name the toolkit will use for the generated device. This must be specified in PascalCase</li>
</ul>
<h2 id="using-the-output"><a class="header" href="#using-the-output">Using the output</a></h2>
<p>Exactly how you include the generated rust file is up to you. You could generate it into your <code>/src</code> folder and declare it a module, which would be nice for Rust analyzer but forces the generated code to be its own module. Or to include it in an existing module you can use the <a href="https://doc.rust-lang.org/core/macro.include.html"><code>include!</code></a> macro.</p>
<p>However you choose to include it, don’t forget to track the file in your git repo.</p>
<p>The generated code still depends on the device-driver crate, but since we don’t depend on the proc macro anymore we can turn off the default features. So in your <code>Cargo.toml</code> you can now import the toolkit as:</p>
<pre><code class="language-toml">device-driver = { version = &lt;VERSION&gt;, default-features = false }
</code></pre>
<p>This makes it so all unused dependencies are gone.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="writing-an-interface"><a class="header" href="#writing-an-interface">Writing an interface</a></h1>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The device-driver crate and the generated code don’t know anything about how to talk to your device. This means we need to teach it about the interface it has!</p>
</blockquote>
<p>Let’s first create our device:</p>
<pre class="playground"><code class="language-rust no_run"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>device_driver::create_device!(
    device_name: MyDevice,
    dsl: {
        // ...
    }
);
<span class="boring">}</span></code></pre>
<p>This generates a top-level block <code>MyDevice</code> which has a <code>new</code> function that takes ownership of an interface.
We have to create our own interface type that we can pass into it. This type will implement the logic to communicate with the device.</p>
<p>In this example, let’s assume a register ‘foo’ was defined and see what happens:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Our interface struct that owns the bus.
pub struct MyDeviceInterface&lt;BUS&gt; {
    pub bus: BUS,
}

fn try_out() {
    // Initialize the bus somehow. Your HAL should help you there
    let bus = init_bus();
    // Create our custom interface struct
    let interface = MyDeviceInterface { bus };

    // Create the device driver based on the interface
    let mut my_device = MyDevice::new(interface);

    // Try to read the foo register. This results in an error
    let _ = my_device.foo().read();
    // ERROR:               ^^^^ method cannot be called due to unsatisfied trait bounds
    //
    // note: the following trait bounds were not satisfied:
    //       `DeviceInterface: RegisterInterface`
}
<span class="boring">}</span></code></pre>
<p>This example doesn’t compile and outputs an error. Luckily the compiler tells us what’s wrong. The problem is that we provided a device interface that doesn’t provide a way to read or write registers, but we ask the driver to read a register.</p>
<p>The error tells us the device interface should implement the <code>RegisterInterface</code> trait.</p>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>Every kind of operation has its own trait. Find the up-to-date docs of them on <a href="https://docs.rs/device-driver/latest/device_driver/#traits">docs.rs</a>.</p>
<p>There’s an interface for register, command and buffer.</p>
</blockquote>
<p>Of each of the traits there is an async version too. When implemented the async versions of the operations can be used. They’ve got the same name as the normal operations, except they end with <code>_async</code>. The register <code>.read()</code> then becomes <code>.read_async()</code>.</p>
<p>Let’s make our example complete by implementing the <code>RegisterInterface</code>:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>pub struct MyDeviceI2cInterface&lt;BUS&gt; {
    pub bus: BUS,
}

// See the docs of the traits to get more up-to-date information about how and what to impl
impl&lt;BUS: embedded_hal::i2c::I2C&gt; device_driver::RegisterInterface for MyDeviceI2cInterface&lt;BUS&gt; {
    // ...
}

// For the async I2C we can implement the async register interface
impl&lt;BUS: embedded_hal_async::i2c::I2C&gt; device_driver::AsyncRegisterInterface for MyDeviceI2cInterface&lt;BUS&gt; {
    // ...
}

fn try_out_sync() {
    let bus = init_sync_bus(); // Implements the I2c trait
    let interface = MyDeviceI2cInterface { bus };

    let mut my_device = MyDevice::new(interface);

    let _ = my_device.foo().read();
}

async fn try_out_async() {
    let bus = init_async_bus(); // Implements the async I2c trait
    let interface = MyDeviceI2cInterface { bus };

    let mut my_device = MyDevice::new(interface);

    let _ = my_device.foo().read_async().await;
}
<span class="boring">}</span></code></pre>
<p>We’ve now covered how to create an interface type and implement the interface trait you need on it.</p>
<p>Some chips can have multiple interfaces, like both SPI and I2C or SPI and QSPI. You can choose to support them in one type or make separate types for them.</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>You can make your interface type(s) as complex or as simple as you need. It depends on your chip and your requirements what it should look like.
It is good practice, though, to inform the driver users of this with docs and examples.</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="defining-the-device"><a class="header" href="#defining-the-device">Defining the device</a></h1>
<p>This toolkit brings three different kinds of concepts you can use to build various aspects of your driver.</p>
<ul>
<li>The register is some memory located at an address on the device. It contains fields, may have a reset value and could be restrictive in its read and write access.</li>
<li>The command can model multiple things. It can be an event to send to the device so it changes state or it could be an RPC-like call. It can send data and receive back an answer.</li>
<li>The buffer is anything that you’d like to have a <code>Write</code> or <code>Read</code> interface to. A good example is a fifo buffer in a radio chip.</li>
</ul>
<p>The registers, commands and buffers can be grouped into blocks.</p>
<p>Except for buffers all of them can be repeated and ref’ed. Repeats take the same object and repeat them for a repeat count with an address stride.
A ‘ref’ object copies another object and allows to override some values like the address and access.</p>
<p>The registers, commands, buffers, blocks and refs are all called ‘objects’ in this project.</p>
<p>To configure the driver, there’s the global config. In it you can define the address types, various defaults for e.g. byte ordering and the method used for name normalization.</p>
<p>These concepts and how you can use them in your driver are described in more detail in their own chapter.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="global-config"><a class="header" href="#global-config">Global config</a></h1>
<p>The global config exists to house three kinds of configs:</p>
<ol>
<li>Required</li>
<li>Defaults</li>
<li>Transformations</li>
</ol>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>A driver can only have one global config.</p>
</blockquote>
<p>Below is a short overview for the DSL format and the manifest format of the global config and their defaults (or <code>_</code> for no default). The last chapters describe the options in more detail.</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>Use the available default values to your advantage to cut back having to specify things on each individual register, command or buffer.</p>
</blockquote>
<ul>
<li><a href="#global-config">Global config</a>
<ul>
<li><a href="#dsl">DSL</a></li>
<li><a href="#manifest">Manifest</a></li>
<li><a href="#required">Required</a>
<ul>
<li><a href="#register_address_type"><code>register_address_type</code></a></li>
<li><a href="#command_address_type"><code>command_address_type</code></a></li>
<li><a href="#buffer_address_type"><code>buffer_address_type</code></a></li>
</ul>
</li>
<li><a href="#defaults">Defaults</a>
<ul>
<li><a href="#default_register_access"><code>default_register_access</code></a></li>
<li><a href="#default_field_access"><code>default_field_access</code></a></li>
<li><a href="#default_buffer_access"><code>default_buffer_access</code></a></li>
<li><a href="#default_byte_order"><code>default_byte_order</code></a></li>
<li><a href="#default_bit_order"><code>default_bit_order</code></a></li>
</ul>
</li>
<li><a href="#transformations">Transformations</a>
<ul>
<li><a href="#name_word_boundaries"><code>name_word_boundaries</code></a></li>
<li><a href="#defmt_feature"><code>defmt_feature</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl"><a class="header" href="#dsl">DSL</a></h2>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>config {
    type DefaultRegisterAccess = RW;
    type DefaultFieldAccess = RW;
    type DefaultBufferAccess = RW;
    type DefaultByteOrder = _;
    type DefaultBitOrder = LSB0;
    type RegisterAddressType = _;
    type CommandAddressType = _;
    type BufferAddressType = _;
    type NameWordBoundaries = [
        Underscore, Hyphen, Space, LowerUpper,
        UpperDigit, DigitUpper, DigitLower,
        LowerDigit, Acronym,
    ];
    type DefmtFeature = "my-feature";
}
<span class="boring">}</span></code></pre>
<h2 id="manifest"><a class="header" href="#manifest">Manifest</a></h2>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Example is written in json, but works for yaml and toml too when literally translated.</p>
</blockquote>
<pre><code class="language-json">"config": {
    "default_register_access": "RW",
    "default_field_access": "RW",
    "default_buffer_access": "RW",
    "default_byte_order": "_",
    "default_bit_order": "LSB0",
    "register_address_type": "_",
    "command_address_type": "_",
    "buffer_address_type": "_",
    "name_word_boundaries": [
        "Underscore", "Hyphen", "Space", "LowerUpper",
        "UpperDigit", "DigitUpper", "DigitLower",
        "LowerDigit", "Acronym"
    ],
    "defmt_feature": "my-feature"
}
</code></pre>
<h2 id="required"><a class="header" href="#required">Required</a></h2>
<h3 id="register_address_type"><a class="header" href="#register_address_type"><code>register_address_type</code></a></h3>
<p>Specifies the integer type used to represent the address of a register. It is required once a register has been defined.</p>
<p>The value is a string in manifest form or an integer type in DLS form.</p>
<p>Options are: <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code></p>
<h3 id="command_address_type"><a class="header" href="#command_address_type"><code>command_address_type</code></a></h3>
<p>Specifies the integer type used to represent the address of a command. It is required once a command has been defined.</p>
<p>The value is a string in manifest form or an integer type in DLS form.</p>
<p>Options are: <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code></p>
<h3 id="buffer_address_type"><a class="header" href="#buffer_address_type"><code>buffer_address_type</code></a></h3>
<p>Specifies the integer type used to represent the address of a buffer. It is required once a buffer has been defined.</p>
<p>The value is a string in manifest form or an integer type in DLS form.</p>
<p>Options are: <code>u8</code>, <code>u16</code>, <code>u32</code>, <code>u64</code>, <code>i8</code>, <code>i16</code>, <code>i32</code>, <code>i64</code></p>
<h2 id="defaults"><a class="header" href="#defaults">Defaults</a></h2>
<h3 id="default_register_access"><a class="header" href="#default_register_access"><code>default_register_access</code></a></h3>
<p>Provides a default to the access type of registers. Any register can override this.</p>
<p>The value is a string in manifest form or written ‘as is’ in the DSL.</p>
<p>Options are: <code>RW</code> (default), <code>ReadWrite</code>, <code>RO</code>, <code>ReadOnly</code>, <code>WO</code>, <code>WriteOnly</code></p>
<h3 id="default_field_access"><a class="header" href="#default_field_access"><code>default_field_access</code></a></h3>
<p>Provides a default to the access type of fields. Any field can override this.</p>
<p>The value is a string in manifest form or written ‘as is’ in the DSL.</p>
<p>Options are: <code>RW</code> (default), <code>ReadWrite</code>, <code>RO</code>, <code>ReadOnly</code>, <code>WO</code>, <code>WriteOnly</code></p>
<h3 id="default_buffer_access"><a class="header" href="#default_buffer_access"><code>default_buffer_access</code></a></h3>
<p>Provides a default to the access type of buffers. Any buffer can override this.</p>
<p>The value is a string in manifest form or written ‘as is’ in the DSL.</p>
<p>Options are: <code>RW</code> (default), <code>ReadWrite</code>, <code>RO</code>, <code>ReadOnly</code>, <code>WO</code>, <code>WriteOnly</code></p>
<h3 id="default_byte_order"><a class="header" href="#default_byte_order"><code>default_byte_order</code></a></h3>
<p>Sets the global byte order. This is used for the register and command fieldsets.
Any command or register can override it.</p>
<p>The value is a string in manifest form or written ‘as is’ in the DSL.</p>
<p>Options are: <code>LE</code>, <code>BE</code></p>
<h3 id="default_bit_order"><a class="header" href="#default_bit_order"><code>default_bit_order</code></a></h3>
<p>Sets the global bit order. This is used for the register and command fieldsets.
Any command or register can override it.</p>
<p>The value is a string in manifest form or written ‘as is’ in the DSL.</p>
<p>Options are: <code>LSB0</code> (default), <code>MSB0</code></p>
<h2 id="transformations"><a class="header" href="#transformations">Transformations</a></h2>
<h3 id="name_word_boundaries"><a class="header" href="#name_word_boundaries"><code>name_word_boundaries</code></a></h3>
<p>All object, field, enum and enum variant names are converted to the correct casing for where it’s used in the generated code. This is because some of them have dual use like the object names which are used as struct names (PascalCase) and function names (snake_case).</p>
<p>This also aids when copying names from datasheets since they’re often weird, inconsistent, wrong or all three in regards to casing.</p>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>To do proper casing, it must be known when a new word starts. The transition from one word to the next is called a boundary.</p>
</blockquote>
<p>The conversions are done using the <code>convert_case</code> crate. With this config option you can specify the boundaries the crate uses to do the conversions.</p>
<p>Options are: <code>[Boundary]</code> or <code>string</code></p>
<p>The available boundaries can be found in <a href="https://docs.rs/convert_case/0.6.0/convert_case/enum.Boundary.html">the docs</a> of the crate. The boundary names should be specified as strings in the manifest and ‘as is’ in the DSL.</p>
<p>The string is converted to an array of boundaries using <a href="https://docs.rs/convert_case/0.6.0/convert_case/enum.Boundary.html#method.list_from">this function</a> which is a really easy way to define it.</p>
<p>The default value is also provided by the crate from <a href="https://docs.rs/convert_case/0.6.0/convert_case/enum.Boundary.html#method.defaults">this function</a>.</p>
<h3 id="defmt_feature"><a class="header" href="#defmt_feature"><code>defmt_feature</code></a></h3>
<p>When defined the generated code will have defmt implementations on the types gated behind the feature configured with this option.
The feature gate looks like: <code>#[cfg(feature = "&lt;VALUE&gt;")]</code>.
This allows you, the driver author, to optionally include defmt support.</p>
<p>The value is a string in manifest form and also written as a string in the DSL.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="registers"><a class="header" href="#registers">Registers</a></h1>
<p>A register is a piece of addressable memory stored on the device.</p>
<p>It is accessed as a function on the block it’s part of. The function returns a <a href="https://docs.rs/device-driver/latest/device_driver/struct.RegisterOperation.html"><code>RegisterOperation</code></a> which can be used to read/write/modify the register.</p>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut device = MyDevice::new(DeviceInterface::new());

device.foo().write(|reg| reg.set_bar(12345)).unwrap();
assert_eq!(device.foo().read().unwrap().bar(), 12345);
<span class="boring">}</span></code></pre>
<p>Below are minimal and full examples of how registers can be defined.
Only one field is shown, but more can be added. Details about the fields can be read in their own chapter.</p>
<ul>
<li><a href="#registers">Registers</a>
<ul>
<li><a href="#dsl-1">DSL</a></li>
<li><a href="#manifest-1">Manifest</a></li>
<li><a href="#required-1">Required</a>
<ul>
<li><a href="#address"><code>address</code></a></li>
<li><a href="#size_bits"><code>size_bits</code></a></li>
<li><a href="#type-manifest-only"><code>type</code> (manifest only)</a></li>
</ul>
</li>
<li><a href="#optional">Optional</a>
<ul>
<li><a href="#cfg-or-cfg"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc--"><code>description</code> or <code>#[doc = ""]</code></a></li>
<li><a href="#access"><code>access</code></a></li>
<li><a href="#byte_order"><code>byte_order</code></a></li>
<li><a href="#bit_order"><code>bit_order</code></a></li>
<li><a href="#reset_value"><code>reset_value</code></a></li>
<li><a href="#repeat"><code>repeat</code></a></li>
<li><a href="#allow_bit_overlap"><code>allow_bit_overlap</code></a></li>
<li><a href="#allow_address_overlap"><code>allow_address_overlap</code></a></li>
<li><a href="#fields-manifest-only"><code>fields</code> (manifest only)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-1"><a class="header" href="#dsl-1">DSL</a></h2>
<p>Minimal:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register Foo {
    const ADDRESS = 3;
    const SIZE_BITS = 16;

    value: uint = 0..16,
}
<span class="boring">}</span></code></pre>
<p>Full:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Register docs
#[cfg(feature = "bar")]
register Foo {
    type Access = WO;
    type ByteOrder = LE;
    type BitOrder = LSB0;
    const ADDRESS = 3;
    const SIZE_BITS = 16;
    const RESET_VALUE = 0x1234;  // Or [0x34, 0x12]
    const REPEAT = {
        count: 4,
        stride: 2
    };
    const ALLOW_BIT_OVERLAP = false;
    const ALLOW_ADDRESS_OVERLAP = false;

    value: uint = 0..16,
}
<span class="boring">}</span></code></pre>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p><code>type</code> or <code>const</code>, which one is it?<br>It’s <code>type</code> if it’s overriding a global config and <code>const</code> if it’s not.</p>
</blockquote>
<h2 id="manifest-1"><a class="header" href="#manifest-1">Manifest</a></h2>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The biggest differences with the DSL are the additional <code>type</code> field to specify which type of object this is and the <code>fields</code> field that houses all fields.</p>
</blockquote>
<p>Minimal (json):</p>
<pre><code class="language-json">"Foo": {
    "type": "register",
    "address": 3,
    "size_bits": 16,
    "fields": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    }
}
</code></pre>
<p>Full (json):</p>
<pre><code class="language-json">"Foo": {
    "type": "register",
    "cfg": "feature = \"foo\"",
    "description": "Register docs",
    "access": "WO",
    "byte_order": "LE",
    "bit_order": "LSB0",
    "address": 3,
    "size_bits": 16,
    "reset_value": 4066, // Or [52, 18] (no hex in json...)
    "repeat": {
        "count": 4,
        "stride": 2
    },
    "allow_bit_overlap": false,
    "allow_address_overlap": false,
    "fields": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    }
}
</code></pre>
<h2 id="required-1"><a class="header" href="#required-1">Required</a></h2>
<h3 id="address"><a class="header" href="#address"><code>address</code></a></h3>
<p>The address of the register.</p>
<p>Integer value that must fit in the given address type in the global config and can be negative.</p>
<h3 id="size_bits"><a class="header" href="#size_bits"><code>size_bits</code></a></h3>
<p>The size of the register in bits.</p>
<p>Positive integer value. No fields can exceed the size of the register.</p>
<h3 id="type-manifest-only"><a class="header" href="#type-manifest-only"><code>type</code> (manifest only)</a></h3>
<p>The type of the object.</p>
<p>For registers this field is a string with the contents <code>"register"</code>.</p>
<h2 id="optional"><a class="header" href="#optional">Optional</a></h2>
<h3 id="cfg-or-cfg"><a class="header" href="#cfg-or-cfg"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the register.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the register definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc--"><a class="header" href="#description-or-doc--"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated register struct and on the function to access the register.</p>
<h3 id="access"><a class="header" href="#access"><code>access</code></a></h3>
<p>Overrides the default register access.</p>
<p>Options are: <code>RW</code>, <code>ReadWrite</code>, <code>WO</code>, <code>WriteOnly</code>, <code>RO</code>, <code>ReadOnly</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<p>Anything that is not <code>ReadWrite</code> will limit the functions you can call for the registers. <code>.write</code> is only available when the register has write access, <code>.read</code> only when the register has read access and <code>.modify</code> only when the register has full access.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>This only affects the capability of a register being read or written.
It does not affect the <code>access</code> specified on the fields.</p>
<p>This means you can have a register you cannot write, but does have setters for one or more fields.<br>That won’t be harmful or break things, but might look weird.</p>
</blockquote>
<h3 id="byte_order"><a class="header" href="#byte_order"><code>byte_order</code></a></h3>
<p>Overrides the default byte order.</p>
<p>Options are: <code>LE</code>, <code>BE</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<p>When the size of a register is &gt; 8 bits (more than one byte), then either the byte order has to be defined globally as a default or the register needs to define it.</p>
<h3 id="bit_order"><a class="header" href="#bit_order"><code>bit_order</code></a></h3>
<p>Overrides the default bit order. If the global config does not define it, it’s <code>LSB0</code>.</p>
<p>Options are: <code>LSB0</code>, <code>MSB0</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<h3 id="reset_value"><a class="header" href="#reset_value"><code>reset_value</code></a></h3>
<p>Defines the reset or default value of the register.</p>
<p>Can be a number or an array of bytes.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>When specified as an array, this must be formatted as the bytes that are returned by the <code>RegisterInterface</code> implementation. This means that when the register has little endian byte order, the reset value number <code>0x1234</code> would be encoded as <code>[0x34, 0x12]</code> in the array form.<br>The same concern is there for the bit order.</p>
</blockquote>
<p>It is used in the <code>.write</code> function. To reset a register to the default value, it’d look like <code>.write(|_|())</code>. When a zero value is desired instead of the default, you can use the <code>.write_with_zero</code> function instead.</p>
<h3 id="repeat"><a class="header" href="#repeat"><code>repeat</code></a></h3>
<p>Repeat the register a number of times at different addresses.</p>
<p>It is specified with two fields:</p>
<ul>
<li>Count: unsigned integer, the amount of times the register is repeated</li>
<li>Stride: signed integer, the amount the address changes per repeat</li>
</ul>
<p>The calculation is <code>address = base_address + index * stride</code>.</p>
<p>When the repeat field is present, the function to do a register operation will have an extra parameter for the index.</p>
<h3 id="allow_bit_overlap"><a class="header" href="#allow_bit_overlap"><code>allow_bit_overlap</code></a></h3>
<p>Allow field addresses to overlap.</p>
<p>This bool value is false by default.</p>
<h3 id="allow_address_overlap"><a class="header" href="#allow_address_overlap"><code>allow_address_overlap</code></a></h3>
<p>Allow this register to have an address that is equal to another register address.
This calculation is also done for any repeat addresses.</p>
<p>Only exact address matches are checked.</p>
<p>This bool value is false by default.</p>
<h3 id="fields-manifest-only"><a class="header" href="#fields-manifest-only"><code>fields</code> (manifest only)</a></h3>
<p>The fields of the register.</p>
<p>A map where the keys are the names of the fields. All values must be fields.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="commands"><a class="header" href="#commands">Commands</a></h1>
<p>A command is a call to do something. This can be to e.g. change the chip state, do an RPC-like call or to start a radio transmission.</p>
<p>It is accessed as a function on the block it’s part of. The function returns a <a href="https://docs.rs/device-driver/latest/device_driver/struct.CommandOperation.html"><code>CommandOperation</code></a> which can be used to dispatch the command.</p>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut device = MyDevice::new(DeviceInterface::new());

device.foo().dispatch().unwrap();
// Commands can carry data too
let result = device.bar().dispatch(|data| data.set_val(1234)).unwrap();
assert_eq!(result.xeno(), true);
<span class="boring">}</span></code></pre>
<p>Below are minimal and full examples of how commands can be defined.
Only one field is shown, but more can be added. Details about the fields can be read in their own chapter.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>A command can have only input, only output, both input and output, or no fields.</p>
<ul>
<li>When input fields are defined, the dispatch function will have a closure parameter to set up the input value.</li>
<li>When output fields are defined, the dispatch function returns the data that was read back from the device.</li>
</ul>
</blockquote>
<ul>
<li><a href="#commands">Commands</a>
<ul>
<li><a href="#dsl-2">DSL</a></li>
<li><a href="#manifest-2">Manifest</a></li>
<li><a href="#required-2">Required</a>
<ul>
<li><a href="#address-1"><code>address</code></a></li>
<li><a href="#size_bits_in--size_bits_out"><code>size_bits_in</code> &amp; <code>size_bits_out</code></a></li>
<li><a href="#type-manifest-only-1"><code>type</code> (manifest only)</a></li>
</ul>
</li>
<li><a href="#optional-1">Optional</a>
<ul>
<li><a href="#cfg-or-cfg-1"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc---1"><code>description</code> or <code>#[doc = ""]</code></a></li>
<li><a href="#byte_order-1"><code>byte_order</code></a></li>
<li><a href="#bit_order-1"><code>bit_order</code></a></li>
<li><a href="#repeat-1"><code>repeat</code></a></li>
<li><a href="#allow_bit_overlap-1"><code>allow_bit_overlap</code></a></li>
<li><a href="#allow_address_overlap-1"><code>allow_address_overlap</code></a></li>
<li><a href="#in-dsl-or-fields_in-manifest"><code>in</code> (dsl) or <code>fields_in</code> (manifest)</a></li>
<li><a href="#out-dsl-or-fields_out-manifest"><code>out</code> (dsl) or <code>fields_out</code> (manifest)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-2"><a class="header" href="#dsl-2">DSL</a></h2>
<p>Minimal without fields (with address 5):</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>command Foo = 5,
<span class="boring">}</span></code></pre>
<p>Minimal with in and out fields:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>command Foo {
    const ADDRESS = 5;
    const SIZE_BITS_IN = 8;
    const SIZE_BITS_OUT = 16;

    in {
        value: uint = 0..8,
    },
    out {
        value: uint = 0..16,
    }
},
<span class="boring">}</span></code></pre>
<p>Full:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Foo docs
#[cfg(feature = "blah")]
command Foo {
    type ByteOrder = LE;
    type BitOrder = LSB0;
    const ADDRESS = 5;
    const SIZE_BITS_IN = 8;
    const SIZE_BITS_OUT = 16;
    const REPEAT = {
        count: 4,
        stride: 2
    };
    const ALLOW_BIT_OVERLAP = false;
    const ALLOW_ADDRESS_OVERLAP = false;

    in {
        value: uint = 0..8,
    },
    out {
        value: uint = 0..16,
    }
},
<span class="boring">}</span></code></pre>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p><code>type</code> or <code>const</code>, which one is it?<br>It’s <code>type</code> if it’s overriding a global config and <code>const</code> if it’s not.</p>
</blockquote>
<h2 id="manifest-2"><a class="header" href="#manifest-2">Manifest</a></h2>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>The biggest difference with the DSL is the additional <code>type</code> field to specify which type of object this is and the absence of the super short hand.</p>
</blockquote>
<p>Minimal with no fields (json):</p>
<pre><code class="language-json">"Foo": {
    "type": "command",
    "address": 5
}
</code></pre>
<p>Minimal (json):</p>
<pre><code class="language-json">"Foo": {
    "type": "command",
    "address": 5,
    "size_bits_in": 8,
    "fields_in": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 8
        }
    },
    "size_bits_out": 16,
    "fields_out": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    },
}
</code></pre>
<p>Full (json):</p>
<pre><code class="language-json">"Foo": {
    "type": "command",
    "cfg": "feature = \"blah\"",
    "description": "Foo docs",
    "byte_order": "LE",
    "bit_order": "LSB0",
    "address": 5,
    "repeat": {
        "count": 4,
        "stride": 2
    },
    "allow_bit_overlap": false,
    "allow_address_overlap": false,
    "size_bits_in": 8,
    "fields_in": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 8
        }
    },
    "size_bits_out": 16,
    "fields_out": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    },
}
</code></pre>
<h2 id="required-2"><a class="header" href="#required-2">Required</a></h2>
<h3 id="address-1"><a class="header" href="#address-1"><code>address</code></a></h3>
<p>The address of the command.</p>
<p>Integer value that must fit in the given address type in the global config and can be negative.</p>
<h3 id="size_bits_in--size_bits_out"><a class="header" href="#size_bits_in--size_bits_out"><code>size_bits_in</code> &amp; <code>size_bits_out</code></a></h3>
<p>The size of the command in bits for their respective field sets.</p>
<p>Positive integer value. No fields can exceed the specified size.</p>
<p>Only required when their respective field sets are defined.</p>
<h3 id="type-manifest-only-1"><a class="header" href="#type-manifest-only-1"><code>type</code> (manifest only)</a></h3>
<p>The type of the object.</p>
<p>For commands this field is a string with the contents <code>"command"</code>.</p>
<h2 id="optional-1"><a class="header" href="#optional-1">Optional</a></h2>
<h3 id="cfg-or-cfg-1"><a class="header" href="#cfg-or-cfg-1"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the command.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the command definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc---1"><a class="header" href="#description-or-doc---1"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated command input and output structs and on the function to access the command.</p>
<h3 id="byte_order-1"><a class="header" href="#byte_order-1"><code>byte_order</code></a></h3>
<p>Overrides the default byte order.</p>
<p>Options are: <code>LE</code>, <code>BE</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<p>When the size of a command input or output is &gt; 8 bits (more than one byte), then either the byte order has to be defined globally as a default or the command needs to define it.</p>
<p>The value is applied to both the input and output fieldsets.</p>
<h3 id="bit_order-1"><a class="header" href="#bit_order-1"><code>bit_order</code></a></h3>
<p>Overrides the default bit order. If the global config does not define it, it’s <code>LSB0</code>.</p>
<p>Options are: <code>LSB0</code>, <code>MSB0</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<p>The value is applied to both the input and output fieldsets.</p>
<h3 id="repeat-1"><a class="header" href="#repeat-1"><code>repeat</code></a></h3>
<p>Repeat the command a number of times at different addresses.</p>
<p>It is specified with two fields:</p>
<ul>
<li>Count: unsigned integer, the amount of times the command is repeated</li>
<li>Stride: signed integer, the amount the address changes per repeat</li>
</ul>
<p>The calculation is <code>address = base_address + index * stride</code>.</p>
<p>When the repeat field is present, the function to do a command operation will have an extra parameter for the index.</p>
<h3 id="allow_bit_overlap-1"><a class="header" href="#allow_bit_overlap-1"><code>allow_bit_overlap</code></a></h3>
<p>Allow field addresses to overlap.</p>
<p>This bool value is false by default.</p>
<h3 id="allow_address_overlap-1"><a class="header" href="#allow_address_overlap-1"><code>allow_address_overlap</code></a></h3>
<p>Allow this command to have an address that is equal to another command address.
This calculation is also done for any repeat addresses.</p>
<p>Only exact address matches are checked.</p>
<p>This bool value is false by default.</p>
<h3 id="in-dsl-or-fields_in-manifest"><a class="header" href="#in-dsl-or-fields_in-manifest"><code>in</code> (dsl) or <code>fields_in</code> (manifest)</a></h3>
<p>The input fields of the command.</p>
<ul>
<li>For the dsl, a list of fields.</li>
<li>For manifest, a map where the keys are the names of the fields All values must be fields.</li>
</ul>
<h3 id="out-dsl-or-fields_out-manifest"><a class="header" href="#out-dsl-or-fields_out-manifest"><code>out</code> (dsl) or <code>fields_out</code> (manifest)</a></h3>
<p>The output fields of the command.</p>
<ul>
<li>For the dsl, a list of fields.</li>
<li>For manifest, a map where the keys are the names of the fields All values must be fields.</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="field-sets"><a class="header" href="#field-sets">Field sets</a></h1>
<p>A field set is a collection of fields that make up the data of a register, command input or command output.</p>
<p>Each field set generates to a struct where each of the fields are accessible through functions with the names of the fields.</p>
<p>A field set can be created using the <code>new</code> function and will be initialized with the reset value (or zero if there is no reset value). When it’s desired to get an all-zero version of the field set, you can call <code>new_zero</code>.<br>When a ref object overrides the reset value, the field set will have an extra constructor <code>new_as_&lt;ref name&gt;</code> that will use the reset value override for the initial value.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>As a user you should not have to construct your field sets manually in normal use. But it’s available to you for special cases in the generated <code>field_sets</code> module.</p>
</blockquote>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use field_sets::MyFieldSet;

let mut reg = MyFieldSet::new();
reg.set_foo(1234);
let foo = reg.foo();
<span class="boring">}</span></code></pre>
<p>Field sets also implement all bitwise operators for easier manipulation. These operations are done on <em>all</em> underlying bits, even ones that are not part of a field.</p>
<p>There’s also an <code>Into</code> and <code>From</code> implementation to the smallest byte array that can fit the entire field set.</p>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>use field_sets::MyFieldSet;

let all_ones = !MyFieldSet::new_zero();
let lowest_byte_set = MyFieldSet::from([0xFF, 0x00]);
let lowest_byte_inverted = all_ones ^ lowest_byte_set;
<span class="boring">}</span></code></pre>
<p>Below are minimal and full examples of how fields can be defined. There are three major variants:</p>
<ul>
<li>Base type</li>
<li>Converted to custom type</li>
<li>Converted to generated enum</li>
</ul>
<p>The conversions can be fallible or infallible. When the fallible <code>try</code> option is used, reading the field will return a result instead of the type directly. For generated enums, even though they might not be generally infallible when converted from their base type, the toolkit uses extra range information to see if it can safely present an infallible interface regardless.</p>
<ul>
<li><a href="#field-sets">Field sets</a>
<ul>
<li><a href="#dsl-3">DSL</a></li>
<li><a href="#manifest-3">Manifest</a></li>
<li><a href="#required-3">Required</a>
<ul>
<li><a href="#base"><code>base</code></a></li>
<li><a href="#start-end--address-range"><code>start</code>, <code>end</code> &amp; address range</a></li>
</ul>
</li>
<li><a href="#optional-2">Optional</a>
<ul>
<li><a href="#cfg-or-cfg-2"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc---2"><code>description</code> or <code>#[doc = ""]</code></a></li>
<li><a href="#access-1"><code>access</code></a></li>
<li><a href="#conversion">Conversion</a>
<ul>
<li><a href="#to-existing-type">To existing type</a></li>
<li><a href="#to-generated-enum">To generated enum</a></li>
</ul>
</li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-3"><a class="header" href="#dsl-3">DSL</a></h2>
<p>Simple (base type only):</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>foo: uint = 0..5,
bar: bool = 5,
zoof: int = 6..=20,
<span class="boring">}</span></code></pre>
<p>With attributes and access specifier:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Field comment!
#[cfg(blah)]
foo: WO uint = 0..5,
<span class="boring">}</span></code></pre>
<p>With conversion to custom type:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>foo: uint as crate::MyCustomType = 0..16,
bar: int as try crate::MyCustomType2 = 16..32,
<span class="boring">}</span></code></pre>
<p>With conversion to generated enum:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>foo: uint as enum GeneratedEnum {
    A,
    B = 5,
    /// Default value
    C = default,
    D = catch_all,
} = 0..8,
<span class="boring">}</span></code></pre>
<h2 id="manifest-3"><a class="header" href="#manifest-3">Manifest</a></h2>
<p>Simple (base type only) (json):</p>
<pre><code class="language-json">{
  "foo": { 
    "base": "uint",
    "start": 0,
    "end": 5
  },
  "bar": { 
    "base": "bool",
    "start": 5,
  },
  "zoof": { 
    "base": "int",
    "start": 6,
    "end": 21
  }
}
</code></pre>
<p>With attributes and access specifier:</p>
<pre><code class="language-json">{
  "foo": {
    "cfg": "blah",
    "description": "Field comment!",
    "access": "WO",
    "base": "uint",
    "start": 0,
    "end": 5
  }
}
</code></pre>
<p>With conversion to custom type:</p>
<pre><code class="language-json">{
  "foo": {
    "base": "uint",
    "conversion": "crate::MyCustomType",
    "start": 0,
    "end": 16
  },
  "bar": {
    "base": "int",
    "try_conversion": "crate::MyCustomType2",
    "start": 16,
    "end": 32
  }
}
</code></pre>
<p>With conversion to generated enum:</p>
<pre><code class="language-json">{
  "foo": {
    "base": "uint",
    "conversion": {
      "name": "GeneratedEnum",
      "A": null,
      "B": 5,
      "C": {
        "description": "Default value",
        "value": "default"
      },
      "D": "catch_all"
    },
    "start": 0,
    "end": 8
  }
}
</code></pre>
<h2 id="required-3"><a class="header" href="#required-3">Required</a></h2>
<h3 id="base"><a class="header" href="#base"><code>base</code></a></h3>
<p>The base type denotes the primitive type used to convert the bits in the address range to a value.</p>
<p>Options:</p>
<ul>
<li>uint - unsigned integer</li>
<li>int - two’s complement signed integer</li>
<li>bool - low or high, only available for 1 bit values</li>
</ul>
<p>The integer options will generate to the smallest signed or unsigned Rust integers that can fit the value. So a 10-bit uint will become a <code>u16</code>.</p>
<p>The value is specified as a string in the manifest format and is written ‘as is’ in the DSL.</p>
<h3 id="start-end--address-range"><a class="header" href="#start-end--address-range"><code>start</code>, <code>end</code> &amp; address range</a></h3>
<p>Every field must specified the bitrange it covers. The way this is done differs a bit between the DSL and the manifest but boil down to the same.</p>
<p>The DLS uses <code>= &lt;ADDRESS&gt;</code> as the syntax. Valid options for the address are:</p>
<ul>
<li>Exclusive range: <code>0..16</code></li>
<li>Inclusive range: <code>0..=16</code></li>
<li>Single address: <code>0</code>
<ul>
<li>Only in combination with bool base types</li>
</ul>
</li>
</ul>
<p>The manifest has two fields <code>start</code> and <code>end</code>, both containing unsigned integers:</p>
<ul>
<li>The <code>start</code> is the starting bit of the field</li>
<li>The <code>end</code> is the exclusive end bit of the field
<ul>
<li>Not required for bool base types</li>
</ul>
</li>
</ul>
<p>The address must lie fully within the size of the defining object and no fields may overlap unless the defining object has the <code>AllowBitOverlap</code> property set to true.</p>
<h2 id="optional-2"><a class="header" href="#optional-2">Optional</a></h2>
<h3 id="cfg-or-cfg-2"><a class="header" href="#cfg-or-cfg-2"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the command.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the field definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc---2"><a class="header" href="#description-or-doc---2"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated field getter and setter.</p>
<h3 id="access-1"><a class="header" href="#access-1"><code>access</code></a></h3>
<p>Overrides the default field access.</p>
<p>Options are: <code>RW</code>, <code>ReadWrite</code>, <code>WO</code>, <code>WriteOnly</code>, <code>RO</code>, <code>ReadOnly</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<p>If the specified access can do read, a getter is generated with the name of the field. If the specified access do write, a setter is generated with the <code>set_</code> prefix followed by the name of the field.</p>
<h3 id="conversion"><a class="header" href="#conversion">Conversion</a></h3>
<p>If the base type of a field is an integer, the value can be converted to a further higher level type. There are two options for this:</p>
<ul>
<li>Conversion to an existing type</li>
<li>Conversion to an inline defined enum value</li>
</ul>
<p>The conversion can be specified as infallible or fallible. When infallible, the field getter will call on the <code>From&lt;INTEGER&gt;</code> trait to convert the base value to the conversion value after which the value is returned. When fallible, the field getter will use the <code>TryFrom&lt;INTEGER&gt;</code> trait instead and will return the result value from it.</p>
<p>In the DSL the conversion is specified using the <code>as &lt;TARGET&gt;</code> or <code>as try &lt;TARGET&gt;</code> keywords for the infallible and fallible variants respectively.</p>
<p>The manifest has two possible fields <code>conversion</code> and <code>try_conversion</code> for the infallible and fallible variants respectively.</p>
<h4 id="to-existing-type"><a class="header" href="#to-existing-type">To existing type</a></h4>
<p>When a type path is given as the DSL <code>&lt;TARGET&gt;</code> or as string in the manifest <code>conversion</code> field, the conversion will be done using the specified type.</p>
<p>The type path is used as is in the generated code, so you need to make sure that the type is in scope.
Due to how the generated modules are structured, the specified paths get <code>super::</code> prepended to them.
To be able to still use extern crates and absolute paths this isn’t done when the path starts with <code>::</code> or <code>crate</code>.</p>
<p>Furthermore the type must implement the <code>From&lt;INTEGER&gt;</code> or <code>TryFrom&lt;INTEGER&gt;</code> traits for the infallible or fallible conversions respectively when the field has read access. When the field has write access, the type must implement the <code>Into&lt;INTEGER&gt;</code> trait.</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>The existing type can also be a enum generated by the toolkit defined in another place by just using the name of that enum.</p>
<p>This has an added bonus that the toolkit still has the information for accepted input which means it can use the infallible conversion method instead of the <code>try</code> fallible one. This creates a nicer and cleaner API.</p>
</blockquote>
<h4 id="to-generated-enum"><a class="header" href="#to-generated-enum">To generated enum</a></h4>
<p>Instead of a custom type, the toolkit can also generate an enum inline.</p>
<p>In the DSL the format for <code>&lt;TARGET&gt;</code> is:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>enum Foo {
    A,
    B = 5, // Also supports bit and hex specification
    /// Comment
    C
}
<span class="boring">}</span></code></pre>
<p>The enum is written pretty much as a normal Rust enum including setting the value of every variant and writing docs on every variant. In this example, the number value of <code>C</code> would be 6.</p>
<p>The generated enum will have the same docs as the field (if any).</p>
<p>In the manifest, the same enum would be specified like so:</p>
<pre><code class="language-json">"conversion": {
  "name": "Foo",
  "description": "Enum docs", // In manifest, enum can be separately documented
  "A": null,
  "B": 5,
  "C": {
    "description": "Comment",
    "value": null
  }
}
</code></pre>
<p>The values for each variant can be the following:</p>
<ul>
<li>Empty or null
<ul>
<li>Use auto counting starting at 0 for the first variant and one higher than the previous variant</li>
</ul>
</li>
<li>Signed integer
<ul>
<li>To manually specify the value</li>
</ul>
</li>
<li><code>default</code>
<ul>
<li>To specify a default value</li>
<li>When the conversion is of a number that doesn’t match any variant, the default variant will be returned</li>
<li>In DSL specified ‘as is’</li>
<li>In manifest specified as a string</li>
<li>Also implements the <code>Default</code> trait for the enum</li>
</ul>
</li>
<li><code>catch_all</code>
<ul>
<li>Similar to default, but makes the variant contain the raw value (like <code>Catch(u8)</code>)</li>
<li>When the conversion is of a number that doesn’t match any variant, the catch all will be returned with the raw value</li>
<li>In DSL specified ‘as is’</li>
<li>In manifest specified as a string</li>
</ul>
</li>
</ul>
<p>When an enum contains both a catch all and a default, the catch all value is used to return unknown numbers.</p>
<p>A generated enum can be used infallibly when any of these properties hold:</p>
<ul>
<li>Any bitpattern of the field is covered by an enum variant</li>
<li>The enum has a default value</li>
<li>The enum has a catch all value</li>
</ul>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="buffers"><a class="header" href="#buffers">Buffers</a></h1>
<p>A buffer is used to represent an stream of bytes on a device. This could for example be a fifo for a radio.
It’s quite a simple construct and thus is limited in configuration options.</p>
<p>It is accessed as a function on the block it’s part of. The function returns a <a href="https://docs.rs/device-driver/latest/device_driver/struct.BufferOperation.html">BufferOperation</a> which can be used to read and write from/to the buffer. This operation type also implements the <a href="https://crates.io/crates/embedded-io">embedded-io</a> traits.</p>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>let mut device = MyDevice::new(DeviceInterface::new());

device.foo().write_all(&amp;[0, 1, 2, 3]).unwrap();
let mut buffer = [0; 8];
let len = device.bar().read(&amp;mut buffer).unwrap();
<span class="boring">}</span></code></pre>
<p>Below are minimal and full examples of how buffers can be defined.</p>
<ul>
<li><a href="#buffers">Buffers</a>
<ul>
<li><a href="#dsl-4">DSL</a></li>
<li><a href="#manifest-4">Manifest</a></li>
<li><a href="#required-4">Required</a>
<ul>
<li><a href="#address-2"><code>address</code></a></li>
<li><a href="#type-manifest-only-2"><code>type</code> (manifest only)</a></li>
</ul>
</li>
<li><a href="#optional-3">Optional</a>
<ul>
<li><a href="#cfg-or-cfg-3"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc---3"><code>description</code> or <code>#[doc = ""]</code></a></li>
<li><a href="#access-2"><code>access</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-4"><a class="header" href="#dsl-4">DSL</a></h2>
<p>Minimal:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>buffer Foo = 5,
<span class="boring">}</span></code></pre>
<p>Full:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// A foo buffer
#[cfg(bar)]
buffer Foo: WO = 5,
<span class="boring">}</span></code></pre>
<h2 id="manifest-4"><a class="header" href="#manifest-4">Manifest</a></h2>
<p>Minimal:</p>
<pre><code class="language-json">"Foo": {
    "type": "buffer",
    "address": 5
},
</code></pre>
<p>Full:</p>
<pre><code class="language-json">"Foo": {
    "type": "buffer",
    "cfg": "bar",
    "description": "A foo buffer",
    "access": "WO",
    "address": 5
},
</code></pre>
<h2 id="required-4"><a class="header" href="#required-4">Required</a></h2>
<h3 id="address-2"><a class="header" href="#address-2"><code>address</code></a></h3>
<p>The address of the buffer.</p>
<p>Integer value that must fit in the given address type in the global config and can be negative.</p>
<h3 id="type-manifest-only-2"><a class="header" href="#type-manifest-only-2"><code>type</code> (manifest only)</a></h3>
<p>The type of the object.</p>
<p>For buffers this field is a string with the contents <code>"buffer"</code>.</p>
<h2 id="optional-3"><a class="header" href="#optional-3">Optional</a></h2>
<h3 id="cfg-or-cfg-3"><a class="header" href="#cfg-or-cfg-3"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the buffer.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the buffer definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc---3"><a class="header" href="#description-or-doc---3"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated buffer struct and on the function to access the buffer.</p>
<h3 id="access-2"><a class="header" href="#access-2"><code>access</code></a></h3>
<p>Overrides the default buffer access.</p>
<p>Options are: <code>RW</code>, <code>ReadWrite</code>, <code>WO</code>, <code>WriteOnly</code>, <code>RO</code>, <code>ReadOnly</code>.<br>They are written ‘as is’ in the DSL and as a string in the manifest.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="blocks"><a class="header" href="#blocks">Blocks</a></h1>
<p>A block is a collection of other objects. This can be great to e.g. pool related objects together.</p>
<p>Blocks have their own address offset which is applied to all child objects. With this repeated and ref blocks are supported and can be used to great effect.</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>The generated code has one implicit root block with the name of the device that acts as the entry point of the driver.
The only difference with other blocks is that it takes ownership of the interface instance and always has address offset 0.</p>
</blockquote>
<p>It is accessed as a function on the parent block it’s part of.</p>
<p>All objects are generated globally so child objects still need a globally unique name and are not generated in a module.</p>
<p>Example usage:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>// MyDevice is the root block
let mut device = MyDevice::new(DeviceInterface::new());

let mut child_block = device.foo();
child_block.bar().dispatch().unwrap();
// Or in one go
device.foo().bar().dispatch().unwrap();
<span class="boring">}</span></code></pre>
<p>Below are minimal and full examples of how blocks can be defined.
There’s one child object defined as example.</p>
<ul>
<li><a href="#blocks">Blocks</a>
<ul>
<li><a href="#dsl-5">DSL</a></li>
<li><a href="#manifest-5">Manifest</a></li>
<li><a href="#required-5">Required</a>
<ul>
<li><a href="#type-manifest-only-3"><code>type</code> (manifest only)</a></li>
</ul>
</li>
<li><a href="#optional-4">Optional</a>
<ul>
<li><a href="#cfg-or-cfg-4"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc---4"><code>description</code> or <code>#[doc = ""]</code></a></li>
<li><a href="#address_offset"><code>address_offset</code></a></li>
<li><a href="#repeat-2"><code>repeat</code></a></li>
<li><a href="#objects-manifest-only"><code>objects</code> (manifest only)</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-5"><a class="header" href="#dsl-5">DSL</a></h2>
<p>Minimal:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>block Foo {
    buffer Bar = 0,
}
<span class="boring">}</span></code></pre>
<p>Full:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>/// Block description
#[cfg(not(blah))]
block Foo {
    const ADDRESS_OFFSET = 10;
    const REPEAT = {
        count: 2,
        stride: 20,
    };

    buffer Bar = 0,
}
<span class="boring">}</span></code></pre>
<h2 id="manifest-5"><a class="header" href="#manifest-5">Manifest</a></h2>
<p>Minimal:</p>
<pre><code class="language-json">"Foo": {
    "type": "block",
    "objects": {
        "Bar": {
            "type": "buffer",
            "address": 0
        }
    }
}
</code></pre>
<p>Full:</p>
<pre><code class="language-json">"Foo": {
    "type": "block",
    "cfg": "not(blah)",
    "description": "Block description",
    "address_offset": 10,
    "repeat": {
        "count": 2,
        "stride": 20,
    },
    "objects": {
        "Bar": {
            "type": "buffer",
            "address": 0
        }
    }
}
</code></pre>
<h2 id="required-5"><a class="header" href="#required-5">Required</a></h2>
<h3 id="type-manifest-only-3"><a class="header" href="#type-manifest-only-3"><code>type</code> (manifest only)</a></h3>
<p>The type of the object.</p>
<p>For blocks this field is a string with the contents <code>"block"</code>.</p>
<h2 id="optional-4"><a class="header" href="#optional-4">Optional</a></h2>
<h3 id="cfg-or-cfg-4"><a class="header" href="#cfg-or-cfg-4"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the block.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the block definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc---4"><a class="header" href="#description-or-doc---4"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated block struct and on the function to access the block.</p>
<h3 id="address_offset"><a class="header" href="#address_offset"><code>address_offset</code></a></h3>
<p>The address offset used for all child objects specified as a signed integer.</p>
<p>The offset is applied to all addresses of the children. So when the offset is 5 and a child specifies address 7, then the actual used address will be 12.</p>
<p>If the offset is not specified, it is default 0.</p>
<h3 id="repeat-2"><a class="header" href="#repeat-2"><code>repeat</code></a></h3>
<p>Repeat the block a number of times at different address offsets.</p>
<p>It is specified with two fields:</p>
<ul>
<li>Count: unsigned integer, the amount of times the block is repeated</li>
<li>Stride: signed integer, the amount the address offset changes per repeat</li>
</ul>
<p>The calculation is <code>offset = base_offset + index * stride</code>.</p>
<p>When the repeat field is present, the function to access a block will have an extra parameter for the index.</p>
<h3 id="objects-manifest-only"><a class="header" href="#objects-manifest-only"><code>objects</code> (manifest only)</a></h3>
<p>A map that contains all the child objects.</p>
<p>For the DSL the children are defined in the block directly.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="refs"><a class="header" href="#refs">Refs</a></h1>
<p>A ref is a copy of another object where parts of that object are overridden with a new value.</p>
<p>For example, you may have two different registers that have the same fields but reside at different addresses. You may not want to use a repeat if they are not logically repeated.</p>
<p>Refs can target registers, commands and blocks. Buffers can’t be reffed because they’re so simple there’s nothing worth overriding. You also can’t ref other refs since that would open the gates of hell in the toolkit implementation.</p>
<blockquote class="blockquote-tag blockquote-tag-note">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 8a8 8 0 1 1 16 0A8 8 0 0 1 0 8Zm8-6.5a6.5 6.5 0 1 0 0 13 6.5 6.5 0 0 0 0-13ZM6.5 7.75A.75.75 0 0 1 7.25 7h1a.75.75 0 0 1 .75.75v2.75h.25a.75.75 0 0 1 0 1.5h-2a.75.75 0 0 1 0-1.5h.25v-2h-.25a.75.75 0 0 1-.75-.75ZM8 6a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Note</p>
<p>Using a ref is exactly the same as using the original, just with the new name. The only difference in API is that if the reset value of a field set is overridden, that fieldset gets an extra constructor with which you can initialize it with the overridden reset value.</p>
<p>The possible overrides are all of the object properties that <em>don’t</em> specify things about the field set. For example, <code>size_bits</code>, <code>fields</code>, <code>byte_order</code> and more can’t be overridden.</p>
</blockquote>
<p>Below are minimal and full examples of how refs can be defined. The examples all override a register and its address.</p>
<ul>
<li><a href="#refs">Refs</a>
<ul>
<li><a href="#dsl-6">DSL</a></li>
<li><a href="#manifest-6">Manifest</a></li>
<li><a href="#required-6">Required</a>
<ul>
<li><a href="#target-manifest-only"><code>target</code> (manifest only)</a></li>
<li><a href="#type-manifest-only-4"><code>type</code> (manifest only)</a></li>
<li><a href="#override-or---"><code>override</code> or <code>{ .. }</code></a></li>
</ul>
</li>
<li><a href="#optional-5">Optional</a>
<ul>
<li><a href="#cfg-or-cfg-5"><code>cfg</code> or <code>#[cfg(...)]</code></a></li>
<li><a href="#description-or-doc---5"><code>description</code> or <code>#[doc = ""]</code></a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="dsl-6"><a class="header" href="#dsl-6">DSL</a></h2>
<p>Minimal:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register Foo {
    const ADDRESS = 3;
    const SIZE_BITS = 16;

    value: uint = 0..16,
},
ref Bar = register Foo {
    const ADDRESS = 5;
},
<span class="boring">}</span></code></pre>
<p>Full:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register Foo {
    const ADDRESS = 3;
    const SIZE_BITS = 16;

    value: uint = 0..16,
},
/// This is a copy of Foo, but now with address 5!
#[cfg(feature = "bar-enabled")]
ref Bar = register Foo {
    const ADDRESS = 5;
},
<span class="boring">}</span></code></pre>
<h2 id="manifest-6"><a class="header" href="#manifest-6">Manifest</a></h2>
<p>Minimal:</p>
<pre><code class="language-json">"Foo": {
    "type": "register",
    "address": 3,
    "size_bits": 16,
    "fields": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    }
},
"Bar": {
    "type": "ref",
    "target": "Foo",
    "override": {
        "type": "register",
        "address": 3,
    }
}
</code></pre>
<p>Full:</p>
<pre><code class="language-json">"Foo": {
    "type": "register",
    "address": 3,
    "size_bits": 16,
    "fields": {
        "value": {
            "base": "uint",
            "start": 0,
            "end": 16
        }
    }
},
"Bar": {
    "type": "ref",
    "target": "Foo",
    "description": "This is a copy of Foo, but now with address 5!",
    "cfg": "feature = \"bar-enabled\"",
    "override": {
        "type": "register",
        "address": 3,
    }
}
</code></pre>
<h2 id="required-6"><a class="header" href="#required-6">Required</a></h2>
<h3 id="target-manifest-only"><a class="header" href="#target-manifest-only"><code>target</code> (manifest only)</a></h3>
<p>The (string) name of the reffed object.</p>
<h3 id="type-manifest-only-4"><a class="header" href="#type-manifest-only-4"><code>type</code> (manifest only)</a></h3>
<p>The type of the object.</p>
<p>For refs this field is a string with the contents <code>"ref"</code>.</p>
<h3 id="override-or---"><a class="header" href="#override-or---"><code>override</code> or <code>{ .. }</code></a></h3>
<p>Contains the override fields of the ref.</p>
<p>This is formatted as an object normally is, but some fields will be rejected.</p>
<h2 id="optional-5"><a class="header" href="#optional-5">Optional</a></h2>
<h3 id="cfg-or-cfg-5"><a class="header" href="#cfg-or-cfg-5"><code>cfg</code> or <code>#[cfg(...)]</code></a></h3>
<p>Allows for cfg-gating the ref.</p>
<p>In the DSL, the normal Rust syntax is used. Just put the attribute on the ref definition. Only one attribute is allowed.</p>
<p>In the manifest it is configured with a string.
The string only defines the inner part: <code>#[cfg(foo)]</code> = <code>"cfg": "foo",</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>Check the chapter on cfg for more information. The cfg’s are not checked by the toolkit and only passed to the generated code and so there are some oddities to be aware of.</p>
</blockquote>
<h3 id="description-or-doc---5"><a class="header" href="#description-or-doc---5"><code>description</code> or <code>#[doc = ""]</code></a></h3>
<p>The doc comments for the generated code.</p>
<p>For the DSL, use the normal doc attributes or triple slash <code>///</code>.
Multiple attributes get concatenated with a newline (just like normal Rust does).</p>
<p>For the manifest, this is a string.</p>
<p>The description is added as normal doc comments to the generated code. So it supports markdown and all other features you’re used to. The description is used on the generated ref struct and on the function to access the ref.</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="dsl-syntax"><a class="header" href="#dsl-syntax">Dsl syntax</a></h1>
<blockquote class="blockquote-tag blockquote-tag-caution">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p>
<p>This doc is written manually. The implementation may differ.
If it does, then either this doc is wrong or the implementation is wrong.
In any case, them disagreeing is a bug. Please file an issue!</p>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>While something may be valid to be parsed, it may not be valid as a construct
and may generate an error deeper down.</p>
</blockquote>
<p>Top-level item is <em>Device</em>.</p>
<ul>
<li>‘*’ is used to signal 0 or more instances.</li>
<li>‘?’ is used to signal 0 or 1 instances.</li>
<li>‘|’ is used as an ‘or’. One of the options in the chain can be used.</li>
<li>‘( )’ is used to group things together.</li>
<li>Any <code>keyword</code> or brackets in the grammar use backticks just like word ‘keyword’ on this line.</li>
</ul>
<p>This doesn’t map perfectly on the YAML and JSON inputs, but they should be made as close as possible.</p>
<p><em>Device</em>:</p>
<blockquote>
<p><em>GlobalConfigList</em><br><em>ObjectList</em></p>
</blockquote>
<p><em>GlobalConfigList</em>:</p>
<blockquote>
<p>(<code>config</code> <code>{</code> <em>GlobalConfig</em>* <code>}</code>)?</p>
</blockquote>
<p><em>GlobalConfig</em>:</p>
<blockquote>
<p>(<code>type</code> <code>DefaultRegisterAccess</code> <code>=</code> <em>Access</em><code>;</code>)<br>| (<code>type</code> <code>DefaultFieldAccess</code> <code>=</code> <em>Access</em><code>;</code>)<br>| (<code>type</code> <code>DefaultBufferAccess</code> <code>=</code> <em>Access</em><code>;</code>)<br>| (<code>type</code> <code>DefaultByteOrder</code> <code>=</code> <em>ByteOrder</em><code>;</code>)<br>| (<code>type</code> <code>DefaultBitOrder</code> <code>=</code> <em>BitOrder</em><code>;</code>)<br>| (<code>type</code> <code>RegisterAddressType</code> <code>=</code> <em>IntegerType</em><code>;</code>)<br>| (<code>type</code> <code>CommandAddressType</code> <code>=</code> <em>IntegerType</em><code>;</code>)<br>| (<code>type</code> <code>BufferAddressType</code> <code>=</code> <em>IntegerType</em><code>;</code>)<br>| (<code>type</code> <code>NameWordBoundaries</code> <code>=</code> <em>NameWordBoundaries</em><code>;</code>)<br>| (<code>type</code> <code>DefmtFeature</code> <code>=</code> <em>String</em><code>;</code>)</p>
</blockquote>
<p><em>NameWordBoundaries</em>:
This specifies the input, not the output. Only applies to object and field names.</p>
<blockquote>
<p>[<em>Boundary</em>*]<br>| <em>String</em></p>
</blockquote>
<p><em>ObjectList</em>:</p>
<blockquote>
<p>(<em>Object</em>(<code>,</code> <em>Object</em>)*<code>,</code>?)?</p>
</blockquote>
<p><em>Object</em>:</p>
<blockquote>
<p><em>Block</em><br>| <em>Register</em><br>| <em>Command</em><br>| <em>Buffer</em><br>| <em>RefObject</em></p>
</blockquote>
<p><em>RefObject</em>:
An object that is a copy of another object. Any items in the object are overrides.</p>
<blockquote>
<p><em>AttributeList</em>
<code>ref</code> <em>IDENTIFIER</em> <code>=</code> <em>Object</em></p>
</blockquote>
<p><em>AttributeList</em>:</p>
<blockquote>
<p><em>Attribute</em>*</p>
</blockquote>
<p><em>Attribute</em>:
Used for documentation and conditional compilation</p>
<blockquote>
<p>(<code>#</code> <code>[</code> <code>doc</code> <code>=</code> <em>STRING</em><code>]</code>)<br>| (<code>#</code> <code>[</code> <code>cfg</code> <code>(</code> <em>ConfigurationPredicate</em><code>)</code> <code>]</code>)</p>
</blockquote>
<p><em>Block</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><code>block</code> <em>IDENTIFIER</em> <code>{</code> <em>BlockItemList</em> <em>ObjectList</em> <code>}</code></p>
</blockquote>
<p><em>BlockItemList</em>:</p>
<blockquote>
<p><em>BlockItem</em>*</p>
</blockquote>
<p><em>BlockItem</em>:</p>
<blockquote>
<p>(<code>const</code> <code>ADDRESS_OFFSET</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <em>Repeat</em>)</p>
</blockquote>
<p><em>Register</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><code>register</code> <em>IDENTIFIER</em> <code>{</code> <em>RegisterItemList</em> <em>FieldList</em> <code>}</code></p>
</blockquote>
<p><em>RegisterItemList</em>:</p>
<blockquote>
<p><em>RegisterItem</em>*</p>
</blockquote>
<p><em>RegisterItem</em>:</p>
<blockquote>
<p>(<code>type</code> <code>Access</code> <code>=</code> <em>Access</em><code>;</code>)<br>| (<code>type</code> <code>ByteOrder</code> <code>=</code> <em>ByteOrder</em><code>;</code>)<br>| (<code>type</code> <code>BitOrder</code> <code>=</code> <em>BitOrder</em><code>;</code>)<br>| (<code>const</code> <code>ADDRESS</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <code>SIZE_BITS</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <code>RESET_VALUE</code> <code>=</code> <em>INTEGER</em> | <em>U8_ARRAY</em><code>;</code>)<br>| (<code>const</code> <em>Repeat</em>)<br>| (<code>const</code> <code>ALLOW_BIT_OVERLAP</code> = <em>BOOL</em><code>;</code>)<br>| (<code>const</code> <code>ALLOW_ADDRESS_OVERLAP</code> = <em>BOOL</em><code>;</code>)</p>
</blockquote>
<p><em>Access</em>:</p>
<blockquote>
<p>(<code>ReadWrite</code>|<code>RW</code>)<br>| (<code>ReadOnly</code>|<code>RO</code>)<br>| (<code>WriteOnly</code>|<code>WO</code>)</p>
</blockquote>
<p><em>ByteOrder</em>:</p>
<blockquote>
<p><code>LE</code>|<code>BE</code></p>
</blockquote>
<p><em>BitOrder</em>:</p>
<blockquote>
<p><code>LSB0</code>|<code>MSB0</code></p>
</blockquote>
<p><em>FieldList</em>:</p>
<blockquote>
<p>(<em>Field</em> (<code>,</code> <em>Field</em>)* <code>,</code>?)</p>
</blockquote>
<p><em>Field</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><em>IDENTIFIER</em><code>:</code> <em>Access</em>? <em>BaseType</em> <em>FieldConversion</em>? <code>=</code> <em>FieldAddress</em></p>
</blockquote>
<p><em>FieldConversion</em>:</p>
<blockquote>
<p>(<code>as</code> <code>try</code>? <em>TYPE_PATH</em>)<br>| (<code>as</code> <code>try</code>? <code>enum</code> <em>IDENTIFIER</em> <code>{</code> <em>EnumVariantList</em><code>}</code>)</p>
</blockquote>
<p><em>EnumVariantList</em>:</p>
<blockquote>
<p><em>EnumVariant</em>(<code>,</code> <em>EnumVariant</em>)*<code>,</code>?</p>
</blockquote>
<p><em>EnumVariant</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><em>IDENTIFIER</em> (<code>=</code> <em>EnumValue</em>)?</p>
</blockquote>
<p><em>EnumValue</em>:</p>
<blockquote>
<p><em>INTEGER</em>|<code>default</code>|<code>catch_all</code></p>
</blockquote>
<p><em>FieldAddress</em>:</p>
<blockquote>
<p><em>INTEGER</em><br>| (<em>INTEGER</em><code>..</code><em>INTEGER</em>)<br>| (<em>INTEGER</em><code>..=</code><em>INTEGER</em>)</p>
</blockquote>
<p><em>BaseType</em>:</p>
<blockquote>
<p><code>bool</code> | <code>uint</code> | <code>int</code></p>
</blockquote>
<p><em>Command</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><code>command</code> <em>IDENTIFIER</em> <em>CommandValue</em>?</p>
</blockquote>
<p><em>CommandValue</em>:</p>
<blockquote>
<p>(<code>=</code> <em>INTEGER</em>)<br>| (<code>{</code> <em>CommandItemList</em> (<code>in</code> <code>{</code> <em>FieldList</em> <code>}</code> <code>,</code>?)? (<code>out</code> <code>{</code> <em>FieldList</em> <code>}</code> <code>,</code>?)? <code>}</code>)</p>
</blockquote>
<p><em>CommandItemList</em>:</p>
<blockquote>
<p><em>CommandItem</em>*</p>
</blockquote>
<p><em>CommandItem</em>:
Commands have data going in and out, so they need two separate data field types.
If no in fields, then no data is sent. If no out fields, then no data is returned.</p>
<blockquote>
<p>(<code>type</code> <code>ByteOrder</code> <code>=</code> <em>ByteOrder</em><code>;</code>)<br>| (<code>type</code> <code>BitOrder</code> <code>=</code> <em>BitOrder</em><code>;</code>)<br>| (<code>const</code> <code>ADDRESS</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <code>SIZE_BITS_IN</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <code>SIZE_BITS_OUT</code> <code>=</code> <em>INTEGER</em><code>;</code>)<br>| (<code>const</code> <em>Repeat</em>)<br>| (<code>const</code> <code>ALLOW_BIT_OVERLAP</code> = <em>BOOL</em><code>;</code>)<br>| (<code>const</code> <code>ALLOW_ADDRESS_OVERLAP</code> = <em>BOOL</em><code>;</code>)</p>
</blockquote>
<p><em>Repeat</em>:</p>
<blockquote>
<p><code>REPEAT</code> <code>=</code> <code>{</code> <code>count</code> <code>:</code> <em>INTEGER</em><code>,</code> <code>stride</code> <code>:</code> <em>INTEGER</em><code>,</code>? <code>}</code> <code>;</code></p>
</blockquote>
<p><em>Buffer</em>:</p>
<blockquote>
<p><em>AttributeList</em><br><code>buffer</code> <em>IDENTIFIER</em>(<code>:</code> <em>Access</em>)? (<code>=</code> <em>INTEGER</em>)?</p>
</blockquote>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="manifest-syntax"><a class="header" href="#manifest-syntax">Manifest syntax</a></h1>
<blockquote class="blockquote-tag blockquote-tag-caution">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p>
<p>This doc is written manually. The implementation may differ.
If it does, then either this doc is wrong or the implementation is wrong.
In any case, them disagreeing is a bug. Please file an issue!</p>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<p>While something may be valid to be parsed, it may not be valid as a construct
and may generate an error deeper down.</p>
</blockquote>
<p>Top-level item is <em>Device</em>.</p>
<p>Anything marked like <em>this</em> denotes its own type specification.</p>
<p>These are the pre-defined types:</p>
<ul>
<li>bool</li>
<li>uint</li>
<li>int</li>
<li>float</li>
<li>string</li>
<li>array
<ul>
<li>Using <code>[]</code> brackets.</li>
<li>If inner types are restricted, then signaled as e.g. <code>[float]</code></li>
</ul>
</li>
<li>map
<ul>
<li>Using <code>{}</code> brackets.</li>
<li>The keys are always text/string.</li>
<li>Restrictions can be signaled as required by <code>?</code></li>
<li>Restriction syntax: `{ foo?, bar?: float, xen: bool, *: bool }
<ul>
<li>Optional field <code>foo</code> without type restriction</li>
<li>Optional field <code>bar</code> with float restriction</li>
<li>Required field <code>xen</code> with bool restriction</li>
<li><code>0..N</code> fields with any name with bool restriction</li>
</ul>
</li>
</ul>
</li>
</ul>
<p>Further restriction can be denoted using <code>oneof()</code>, for example: <code>int oneof(1, 2, 3, 4)</code> or <code>oneof(bool, int)</code></p>
<p><em>Device</em>:
The key of the object will become the name of it</p>
<pre><code>{
    config?: _GlobalConfig_,
    *: _Object_
}
</code></pre>
<p><em>GlobalConfig</em>:</p>
<pre><code>{
    default_register_access?: _Access_,
    default_field_access?: _Access_,
    default_buffer_access?: _Access_,
    default_byte_order?: _ByteOrder_,
    default_bit_order?: _BitOrder_,
    register_address_type?: _IntegerType_,
    command_address_type?: _IntegerType_,
    buffer_address_type?: _IntegerType_,
    name_word_boundaries?: _NameWordBoundaries_
    defmt_feature?: string
}
</code></pre>
<p><em>Access</em>:</p>
<pre><code>string oneof("ReadWrite", "RW", "ReadOnly", "RO", "WriteOnly", "WO")
</code></pre>
<p><em>ByteOrder</em>:</p>
<pre><code>string oneof("LE", "BE")
</code></pre>
<p><em>BitOrder</em>:</p>
<pre><code>string oneof("LSB0", "MSB0")
</code></pre>
<p><em>IntegerType</em>:</p>
<pre><code>string oneof("u8", "u16", "u32", "i8", "i16", "i32", "i64")
</code></pre>
<p><em>NameWordBoundaries</em>:</p>
<pre><code>oneof([_Boundary_], string)
</code></pre>
<p><em>Object</em>:</p>
<pre><code>oneof(
  _Block_,
  _Register_,
  _Command_,
  _Buffer_,
  _RefObject_
)
</code></pre>
<p><em>RefObject</em>:</p>
<pre><code>{
    type: string oneof("ref"),
    cfg?: string,
    description?: string,
    target: string,
    override: _Object_,
}
</code></pre>
<p><em>Block</em>:</p>
<pre><code>{
    type: string oneof("block"),
    cfg?: string,
    description?: string,
    address_offset?: int,
    repeat?: _Repeat_,
    objects?: {
        *: _Object_
    }
}
</code></pre>
<p><em>Repeat</em>:</p>
<pre><code>{
    count: uint,
    stride: int
}
</code></pre>
<p><em>Register</em>:</p>
<pre><code>{
    type: string oneof("register"),
    cfg?: string,
    description?: string,
    access?: _Access_,
    byte_order?: _ByteOrder_,
    bit_order?: _BitOrder_,
    address: int,
    size_bits: int,
    reset_value?: oneof(int, [uint]),
    repeat?: _Repeat_,
    allow_bit_overlap?: bool,
    allow_address_overlap?: bool,
    fields?: {
        *: _Field_
    }
}
</code></pre>
<p><em>Field</em>:</p>
<pre><code>{
    cfg?: string,
    description?: string,
    access?: _Access_,
    base: _BaseType_,
    conversion?: _FieldConversion_,
    try_conversion?: _FieldConversion_,
    start: int,
    end?: int,
}
</code></pre>
<p><em>BaseType</em>:</p>
<pre><code>string oneof("bool", "int", "uint")
</code></pre>
<p><em>FieldConversion</em>:</p>
<pre><code>oneof(
    string,
    {
        name: string,
        description?: string,
        *: _EnumVariant_
    }
)
</code></pre>
<p><em>EnumVariant</em>:</p>
<pre><code>oneof(
    _EnumValue_,
    {
        cfg?: string,
        description?: string,
        value?: _EnumValue_
    }
)
</code></pre>
<p><em>EnumValue</em>:</p>
<pre><code>oneof(
    null, int, string oneof("default", "catch_all")
)
</code></pre>
<p><em>Command</em>:</p>
<pre><code>{
    type: string oneof("command"),
    cfg?: string,
    description?: string,
    byte_order?: _ByteOrder_,
    bit_order?: _BitOrder_,
    address: int,
    repeat?: _Repeat_,
    allow_bit_overlap?: bool,
    allow_address_overlap?: bool,
    size_bits_in?: int,
    fields_in?: {
        *: _Field_
    },
    size_bits_out?: int,
    fields_out?: {
        *: _Field_
    },
}
</code></pre>
<p><em>Buffer</em>:</p>
<pre><code>{
    type: string oneof("buffer"),
    cfg?: string,
    description?: string,
    access?: _Access_,
    address: int,
}
</code></pre>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="cfg"><a class="header" href="#cfg">Cfg</a></h1>
<p>Pretty much anywhere you can put docs/description, you can also put some cfg. They use the same syntax as the inside of the cfg attribute, e.g. <code>feature = "blah"</code>.</p>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>The cfg’s have no impact on the code generation other than forwarding the cfg’s as attributes on items.</p>
</blockquote>
<p>This presents a couple of challenges:</p>
<ul>
<li>It’s quite hard to check whether a driver can compile with any combination of cfg’s.</li>
<li>The cfg’s are resolved after code generation, so the toolkit can’t check anything.</li>
<li>It’s hard to predict how the cfg attributes on various items interact.</li>
</ul>
<p>So what does this all mean?</p>
<blockquote class="blockquote-tag blockquote-tag-caution">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M4.47.22A.749.749 0 0 1 5 0h6c.199 0 .389.079.53.22l4.25 4.25c.141.14.22.331.22.53v6a.749.749 0 0 1-.22.53l-4.25 4.25A.749.749 0 0 1 11 16H5a.749.749 0 0 1-.53-.22L.22 11.53A.749.749 0 0 1 0 11V5c0-.199.079-.389.22-.53Zm.84 1.28L1.5 5.31v5.38l3.81 3.81h5.38l3.81-3.81V5.31L10.69 1.5ZM8 4a.75.75 0 0 1 .75.75v3.5a.75.75 0 0 1-1.5 0v-3.5A.75.75 0 0 1 8 4Zm0 8a1 1 0 1 1 0-2 1 1 0 0 1 0 2Z"></path></svg>Caution</p>
<ul>
<li>The support for cfg’s are best effort only. Expect things to be weird or something to work against you.</li>
<li>Some analysis may not be done on objects with cfg which can lead to weird errors in the generated code since problems are not caught beforehand.</li>
</ul>
</blockquote>
<blockquote class="blockquote-tag blockquote-tag-warning">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M6.457 1.047c.659-1.234 2.427-1.234 3.086 0l6.082 11.378A1.75 1.75 0 0 1 14.082 15H1.918a1.75 1.75 0 0 1-1.543-2.575Zm1.763.707a.25.25 0 0 0-.44 0L1.698 13.132a.25.25 0 0 0 .22.368h12.164a.25.25 0 0 0 .22-.368Zm.53 3.996v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 11a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Warning</p>
<ul>
<li>If you use cfg’s, check the generated code to see if everything looks alright.</li>
<li>Use cfg’s only sparingly.</li>
<li>Test all realistic cfg combinations, preferably even in CI.</li>
</ul>
</blockquote>
<p>If there is a problem and the toolkit can do better, then please make an issue!</p>
<div style="break-before: page; page-break-before: always;"></div>
<h1 id="memory"><a class="header" href="#memory">Memory</a></h1>
<p>Memory is quite easy. But assigning meaning to it is where all complexity comes from.
This page describes all the different levels of memory and what this crate does.
The goal is to leave you with a better understanding of how memory is handled and to serve as a quick reference if or when
confusion ensues.</p>
<ul>
<li><a href="#memory">Memory</a>
<ul>
<li><a href="#concepts">Concepts</a>
<ul>
<li><a href="#byte-order">Byte order</a></li>
<li><a href="#bit-order">Bit order</a></li>
<li><a href="#together">Together</a></li>
</ul>
</li>
<li><a href="#the-memories-of-device-driver">The memories of device-driver</a>
<ul>
<li><a href="#example-lis3dh---multi-register-le-lsb0">Example LIS3DH - Multi-register LE, LSB0</a></li>
<li><a href="#example-s2-lp---multi-register-be-lsb0">Example s2-lp - Multi-register BE, LSB0</a></li>
<li><a href="#example-dw1000---single-register-le-lsb0">Example DW1000 - Single-register LE, LSB0</a></li>
</ul>
</li>
</ul>
</li>
</ul>
<h2 id="concepts"><a class="header" href="#concepts">Concepts</a></h2>
<h3 id="byte-order"><a class="header" href="#byte-order">Byte order</a></h3>
<p>Also known as endianness. It describes what the first byte is in an array of bytes.
There are two options generally:</p>
<ul>
<li>Little endian (LE)
<ul>
<li>The smallest or first byte is at the front</li>
<li>I.E. <code>[10, 11, 12, 13]</code> where indexing at 0 would yield <code>10</code></li>
<li>Lower indices are in lower memory addresses, higher indices are in higher memory addresses</li>
</ul>
</li>
<li>Big endian (BE)
<ul>
<li>The smallest or first byte is at the back</li>
<li>I.E. <code>[10, 11, 12, 13]</code> where indexing at 0 would yield <code>13</code></li>
<li>Lower indices are in higher memory addresses, higher indices are in lower memory addresses</li>
</ul>
</li>
</ul>
<h3 id="bit-order"><a class="header" href="#bit-order">Bit order</a></h3>
<p>There is also order on the bit level. We get to decide which bit is the smallest of the 8 in a byte.
There’s two options:</p>
<ul>
<li>Least significant bit 0 (LSB0)
<ul>
<li>The bit at index 0 is the lowest bit</li>
<li>I.E. the number <code>1</code> is coded as <code>0b0000_0001</code> or <code>0x01</code></li>
</ul>
</li>
<li>Most significant bit 0 (MSB0)
<ul>
<li>The bit at index 0 is the highest bit</li>
<li>I.E. the number <code>1</code> is coded as <code>0b1000_0000</code> or <code>0x80</code></li>
</ul>
</li>
</ul>
<h3 id="together"><a class="header" href="#together">Together</a></h3>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>Together, the bit and byte order determine where a given bit is in an array of bytes.</p>
</blockquote>
<p>Bit <code>0</code> is defined as the <code>0th</code> bit on the <code>0th</code> byte.<br>Bit <code>10</code> is defined as the <code>2nd</code> bit on the <code>1st</code> byte.</p>
<p>Here are the options for when only bit 0 is high in a 2-byte array:</p>
<pre><code>LE, LSB0:
  [0b0000_0001, 0b0000_0000] or [0x01, 0x00]
             ^            ^  &lt;- Bits 0
   ^^^^^^^^^^^               &lt;- Byte 0

LE, MSB0:
  [0b1000_0000, 0b0000_0000] or [0x80, 0x00]
     ^            ^          &lt;- Bits 0
   ^^^^^^^^^^^               &lt;- Byte 0

BE, LSB0:
  [0b0000_0000, 0b0000_0001] or [0x00, 0x01]
             ^            ^  &lt;- Bits 0
                ^^^^^^^^^^^  &lt;- Byte 0

BE, MSB0:
  [0b0000_0000, 0b1000_0000] or [0x00, 0x80]
     ^            ^          &lt;- Bits 0
                ^^^^^^^^^^^  &lt;- Byte 0
</code></pre>
<p>Here are the options for when only bit 10 is high in a 2-byte array:</p>
<pre><code>LE, LSB0:
  [0b0000_0000, 0b0000_0100] or [0x00, 0x04]
           ^            ^    &lt;- Bits 2
                ^^^^^^^^^^^  &lt;- Byte 1

LE, MSB0:
  [0b0000_0000, 0b0010_0000] or [0x00, 0x20]
       ^            ^        &lt;- Bits 2
                ^^^^^^^^^^^  &lt;- Byte 1

BE, LSB0:
  [0b0000_0100, 0b0000_0000] or [0x04, 0x00]
           ^            ^    &lt;- Bits 2
   ^^^^^^^^^^^               &lt;- Byte 1

BE, MSB0:
  [0b0010_0000, 0b0000_0000] or [0x20, 0x00]
       ^            ^        &lt;- Bits 2
   ^^^^^^^^^^^               &lt;- Byte 1
</code></pre>
<h2 id="the-memories-of-device-driver"><a class="header" href="#the-memories-of-device-driver">The memories of device-driver</a></h2>
<blockquote class="blockquote-tag blockquote-tag-important">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M0 1.75C0 .784.784 0 1.75 0h12.5C15.216 0 16 .784 16 1.75v9.5A1.75 1.75 0 0 1 14.25 13H8.06l-2.573 2.573A1.458 1.458 0 0 1 3 14.543V13H1.75A1.75 1.75 0 0 1 0 11.25Zm1.75-.25a.25.25 0 0 0-.25.25v9.5c0 .138.112.25.25.25h2a.75.75 0 0 1 .75.75v2.19l2.72-2.72a.749.749 0 0 1 .53-.22h6.5a.25.25 0 0 0 .25-.25v-9.5a.25.25 0 0 0-.25-.25Zm7 2.25v2.5a.75.75 0 0 1-1.5 0v-2.5a.75.75 0 0 1 1.5 0ZM9 9a1 1 0 1 1-2 0 1 1 0 0 1 2 0Z"></path></svg>Important</p>
<p>Here’s the tricky part. The data of a register can be present in three places:</p>
<ul>
<li>On the device</li>
<li>On the transport bus (e.g. while writing/reading it over SPI)</li>
<li>In RAM on your microcontroller</li>
</ul>
</blockquote>
<p>The first two we don’t have any influence over. But we can create our own model with this crate that fits the device.</p>
<p>Let’s do some examples for real existing devices.
If there’s a device that does things a bit different, feel free to PR this file!</p>
<blockquote class="blockquote-tag blockquote-tag-tip">
<p class="blockquote-tag-title"><svg viewbox="0 0 16 16" width="18" height="18"><path d="M8 1.5c-2.363 0-4 1.69-4 3.75 0 .984.424 1.625.984 2.304l.214.253c.223.264.47.556.673.848.284.411.537.896.621 1.49a.75.75 0 0 1-1.484.211c-.04-.282-.163-.547-.37-.847a8.456 8.456 0 0 0-.542-.68c-.084-.1-.173-.205-.268-.32C3.201 7.75 2.5 6.766 2.5 5.25 2.5 2.31 4.863 0 8 0s5.5 2.31 5.5 5.25c0 1.516-.701 2.5-1.328 3.259-.095.115-.184.22-.268.319-.207.245-.383.453-.541.681-.208.3-.33.565-.37.847a.751.751 0 0 1-1.485-.212c.084-.593.337-1.078.621-1.489.203-.292.45-.584.673-.848.075-.088.147-.173.213-.253.561-.679.985-1.32.985-2.304 0-2.06-1.637-3.75-4-3.75ZM5.75 12h4.5a.75.75 0 0 1 0 1.5h-4.5a.75.75 0 0 1 0-1.5ZM6 15.25a.75.75 0 0 1 .75-.75h2.5a.75.75 0 0 1 0 1.5h-2.5a.75.75 0 0 1-.75-.75Z"></path></svg>Tip</p>
<p>If all registers have the same behaviour (which is the case usually), you can set the bit and byte orders in the global config too so it applies to all registers that don’t explicitly have it set.</p>
</blockquote>
<h3 id="example-lis3dh---multi-register-le-lsb0"><a class="header" href="#example-lis3dh---multi-register-le-lsb0">Example LIS3DH - Multi-register LE, LSB0</a></h3>
<p>The LIS3DH accelerometer is one byte per register, but there are some multi-register values that we may want to model as one two-byte register. This can be done because the address will auto increment after any reads/writes.</p>
<p>In the datasheet we find the registers:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Name</th><th>Access</th><th>Address</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td>OUT_X_L</td><td>ro</td><td>0x28</td><td><code>X [0..8]</code></td></tr>
<tr><td>OUT_X_H</td><td>ro</td><td>0x29</td><td><code>X [8..16]</code></td></tr>
</tbody>
</table>
</div>
<p>And the transport schema:</p>
<pre><code>CS : ¯¯\___________________________________________________________/¯¯¯¯
SPC: ¯¯¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯¯¯¯¯
SDI: ===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===
         R!W                         DI7 DI6 DI5 DI4 DI3 DI2 DI1 DI0
             M!S AD5 AD4 AD3 AD2 AD0
SDO: -------------------------------x===x===x===x===x===x===x===x===x---
                                     DO7 DO6 DO5 DO4 DO3 DO2 DO1 DO0
</code></pre>
<p>Let’s analyze:</p>
<p>Byte order</p>
<ul>
<li>We will make one register out of the two starting at address 0x28</li>
<li>The first byte will be from <code>OUT_X_L</code> and the second byte will be from <code>OUT_X_H</code></li>
<li>So, low index is low byte and high index is high byte</li>
<li>Thus this combined register is <strong>little endian (LE)</strong></li>
</ul>
<p>Bit order</p>
<ul>
<li>Depends on the hardware settings of the SPI. We set it to most significant bit first to match the datasheet.</li>
<li>The 0th bit is the last and least significant one of the byte</li>
<li>Thus this is <strong>Least Significant Bit 0 (LSB0)</strong></li>
</ul>
<p>And so we get our register definition:</p>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register OutX {
    const ADDRESS = 0x68; // Including bit for multi-register ops
    const SIZE_BITS = 16;
    type ByteOrder = LE;
    type BitOrder = LSB0;

    value: int = 0..16,
}
<span class="boring">}</span></code></pre>
<h3 id="example-s2-lp---multi-register-be-lsb0"><a class="header" href="#example-s2-lp---multi-register-be-lsb0">Example s2-lp - Multi-register BE, LSB0</a></h3>
<p>This is a radio chip and just like the LIS3DH can combine multiple registers in one read/write.</p>
<p>In the datasheet we find the registers:</p>
<div class="table-wrapper">
<table>
<thead>
<tr><th>Name</th><th>Address</th><th>Bits</th><th>Value</th></tr>
</thead>
<tbody>
<tr><td>SYNT3</td><td>05</td><td>7:5</td><td>PLL_CP_ISEL</td></tr>
<tr><td></td><td></td><td>4</td><td>BS</td></tr>
<tr><td></td><td></td><td>3:0</td><td>SYNT[27:24]</td></tr>
<tr><td>SYNT2</td><td>06</td><td>7:0</td><td>SYNT[23:16]</td></tr>
<tr><td>SYNT1</td><td>07</td><td>7:0</td><td>SYNT[15:8]</td></tr>
<tr><td>SYNT0</td><td>08</td><td>7:0</td><td>SYNT[7:0]</td></tr>
</tbody>
</table>
</div>
<p>And the transport schema (for writes):</p>
<pre><code>CSn : ¯¯\_______________________________________________________________________________________________/¯¯¯¯
SCLK: ¯¯¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯\_/¯¯¯¯¯
MOSI: ---x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x===x---
          A/C  0   0   0   0   0   0  W/R  A7  A6  A5  A4  A3  A2  A1  A0  D7  D6  D5  D4  D3  D2  D1  D0
         | header                        | address                       | data
</code></pre>
<p>Let’s analyze:</p>
<p>Byte order</p>
<ul>
<li>We will make one register out of this starting at address 0x05</li>
<li>The first byte will contain <code>SYNT[27:24]</code> and the last byte will contain <code>SYNT[7:0]</code></li>
<li>So, low index is high byte and high index is low byte</li>
<li>Thus this combined register is <strong>big endian (BE)</strong></li>
</ul>
<p>Bit order</p>
<ul>
<li>Depends on the hardware settings of the SPI. We set it to most significant bit first to match the datasheet.</li>
<li>The 0th bit is the last/least significant one</li>
<li>Thus this is <strong>Least Significant Bit 0 (LSB0)</strong></li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register OutX {
    const ADDRESS = 0x05;
    const SIZE_BITS = 32;
    type ByteOrder = BE;
    type BitOrder = LSB0;

    synt: uint = 0..=27,
    bs: bool = 28,
    pll_cp_isel: uint = 29..=31
}
<span class="boring">}</span></code></pre>
<h3 id="example-dw1000---single-register-le-lsb0"><a class="header" href="#example-dw1000---single-register-le-lsb0">Example DW1000 - Single-register LE, LSB0</a></h3>
<p>This chip doesn’t have multi register reads, but it does have registers bigger than a byte.
So even a single register must take care of byte ordering.</p>
<p>Luckily for us, the user manual spells out the modes (along to the diagrams):</p>
<ul>
<li>
<blockquote>
<p>Note: The octets of a multi-octet value are transferred on the SPI interface in octet order beginning with the low-order octet.</p>
</blockquote>
</li>
<li>Diagram example: Register <code>0x00</code> contains <code>0xDECA0130</code> and is sent as <code>[0x30, 0x01, 0xCA, 0xDE]</code>
<ul>
<li>Thus <strong>little endian (LE)</strong></li>
</ul>
</li>
<li>
<blockquote>
<p>Note: The octets are physically presented on the SPI interface data lines with the high order bit sent first in time.</p>
</blockquote>
<ul>
<li>Depends on the hardware settings of the SPI. We set it to most significant bit first to match the datasheet.</li>
<li>Thus <strong>Least Significant Bit 0 (LSB0)</strong> (assuming your SPI master also sees the first bit as the LSB)</li>
</ul>
</li>
</ul>
<pre class="playground"><code class="language-rust"><span class="boring">#![allow(unused)]
</span><span class="boring">fn main() {
</span>register DevId {
    const ADDRESS = 0x00;
    const SIZE_BITS = 32;
    type ByteOrder = LE;
    type BitOrder = LSB0;

    r_id_tag: uint = 16..32,
    model: uint = 8..16,
    ver: uint = 4..8,
    rev: uint = 0..4
}
<span class="boring">}</span></code></pre>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->


                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">

            </nav>

        </div>

        <template id=fa-eye><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 576 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M288 32c-80.8 0-145.5 36.8-192.6 80.6C48.6 156 17.3 208 2.5 243.7c-3.3 7.9-3.3 16.7 0 24.6C17.3 304 48.6 356 95.4 399.4C142.5 443.2 207.2 480 288 480s145.5-36.8 192.6-80.6c46.8-43.5 78.1-95.4 93-131.1c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C433.5 68.8 368.8 32 288 32zM432 256c0 79.5-64.5 144-144 144s-144-64.5-144-144s64.5-144 144-144s144 64.5 144 144zM288 192c0 35.3-28.7 64-64 64c-11.5 0-22.3-3-31.6-8.4c-.2 2.8-.4 5.5-.4 8.4c0 53 43 96 96 96s96-43 96-96s-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6z"/></svg></span></template>
        <template id=fa-eye-slash><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 640 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M38.8 5.1C28.4-3.1 13.3-1.2 5.1 9.2S-1.2 34.7 9.2 42.9l592 464c10.4 8.2 25.5 6.3 33.7-4.1s6.3-25.5-4.1-33.7L525.6 386.7c39.6-40.6 66.4-86.1 79.9-118.4c3.3-7.9 3.3-16.7 0-24.6c-14.9-35.7-46.2-87.7-93-131.1C465.5 68.8 400.8 32 320 32c-68.2 0-125 26.3-169.3 60.8L38.8 5.1zM223.1 149.5C248.6 126.2 282.7 112 320 112c79.5 0 144 64.5 144 144c0 24.9-6.3 48.3-17.4 68.7L408 294.5c5.2-11.8 8-24.8 8-38.5c0-53-43-96-96-96c-2.8 0-5.6 .1-8.4 .4c5.3 9.3 8.4 20.1 8.4 31.6c0 10.2-2.4 19.8-6.6 28.3l-90.3-70.8zm223.1 298L373 389.9c-16.4 6.5-34.3 10.1-53 10.1c-79.5 0-144-64.5-144-144c0-6.9 .5-13.6 1.4-20.2L83.1 161.5C60.3 191.2 44 220.8 34.5 243.7c-3.3 7.9-3.3 16.7 0 24.6c14.9 35.7 46.2 87.7 93 131.1C174.5 443.2 239.2 480 320 480c47.8 0 89.9-12.9 126.2-32.5z"/></svg></span></template>
        <template id=fa-copy><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M502.6 70.63l-61.25-61.25C435.4 3.371 427.2 0 418.7 0H255.1c-35.35 0-64 28.66-64 64l.0195 256C192 355.4 220.7 384 256 384h192c35.2 0 64-28.8 64-64V93.25C512 84.77 508.6 76.63 502.6 70.63zM464 320c0 8.836-7.164 16-16 16H255.1c-8.838 0-16-7.164-16-16L239.1 64.13c0-8.836 7.164-16 16-16h128L384 96c0 17.67 14.33 32 32 32h47.1V320zM272 448c0 8.836-7.164 16-16 16H63.1c-8.838 0-16-7.164-16-16L47.98 192.1c0-8.836 7.164-16 16-16H160V128H63.99c-35.35 0-64 28.65-64 64l.0098 256C.002 483.3 28.66 512 64 512h192c35.2 0 64-28.8 64-64v-32h-47.1L272 448z"/></svg></span></template>
        <template id=fa-play><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 384 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M73 39c-14.8-9.1-33.4-9.4-48.5-.9S0 62.6 0 80V432c0 17.4 9.4 33.4 24.5 41.9s33.7 8.1 48.5-.9L361 297c14.3-8.7 23-24.2 23-41s-8.7-32.2-23-41L73 39z"/></svg></span></template>
        <template id=fa-clock-rotate-left><span class=fa-svg><svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512"><!--! Font Awesome Free 6.2.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2022 Fonticons, Inc. --><path d="M75 75L41 41C25.9 25.9 0 36.6 0 57.9V168c0 13.3 10.7 24 24 24H134.1c21.4 0 32.1-25.9 17-41l-30.8-30.8C155 85.5 203 64 256 64c106 0 192 86 192 192s-86 192-192 192c-40.8 0-78.6-12.7-109.7-34.4c-14.5-10.1-34.4-6.6-44.6 7.9s-6.6 34.4 7.9 44.6C151.2 495 201.7 512 256 512c141.4 0 256-114.6 256-256S397.4 0 256 0C185.3 0 121.3 28.7 75 75zm181 53c-13.3 0-24 10.7-24 24V256c0 6.4 2.5 12.5 7 17l72 72c9.4 9.4 24.6 9.4 33.9 0s9.4-24.6 0-33.9l-65-65V152c0-13.3-10.7-24-24-24z"/></svg></span></template>



        <script>
            window.playground_copyable = true;
        </script>


        <script src="elasticlunr-ef4e11c1.min.js"></script>
        <script src="mark-09e88c2c.min.js"></script>
        <script src="searcher-c2a407aa.js"></script>

        <script src="clipboard-1626706a.min.js"></script>
        <script src="highlight-abc7f01d.js"></script>
        <script src="book-a0b12cfe.js"></script>

        <!-- Custom JS scripts -->

        <script>
        window.addEventListener('load', function() {
            window.setTimeout(window.print, 100);
        });
        </script>


    </div>
    </body>
</html>
